<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>AFNS Elite Player Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:radial-gradient(circle at top,#1a2f5c 0%,#0b1c33 40%,#1a0f1f 75%,#000 100%);
  color:#fff;
}
.container{max-width:700px;margin:auto;padding:20px;}
header{text-align:center;margin-bottom:20px;}
header img{width:90px;}
.card{
  background:linear-gradient(145deg,#0f2545,#081a2e);
  padding:20px;border-radius:22px;
  box-shadow:0 0 25px rgba(255,215,0,.15),0 0 40px rgba(0,120,255,.15);
}
.name{font-size:22px;font-weight:bold;color:#ffd34d;}
.email{opacity:.85;margin-bottom:8px;}
.rank-badge{
  display:inline-block;padding:6px 14px;border-radius:25px;
  background:linear-gradient(45deg,#ff3b3b,#ffae00);
  color:#fff;font-weight:bold;margin-top:6px;
}
.progress{background:#0c223f;border-radius:10px;overflow:hidden;height:10px;margin:12px 0;}
.progress-bar{height:100%;background:linear-gradient(90deg,#4db8ff,#ffd34d);width:0%;transition:.5s;}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:15px;}
.stat{
  background:linear-gradient(145deg,#132f55,#0d203a);
  padding:14px;border-radius:14px;text-align:center;
}
.stat h3{margin:5px 0;color:#ffd34d;}
button{
  width:100%;padding:12px;margin-top:10px;border:none;
  border-radius:12px;cursor:pointer;font-weight:bold;
  background:linear-gradient(45deg,#1e5eff,#00c6ff);
  color:#fff;
}
button.secondary{background:#1a1a1a;color:#ccc;}
.home-btn{background:linear-gradient(45deg,#ff9800,#ff3d00);}
.hidden{display:none;}
.match-history{margin-top:20px;}
.match-card{
  background:linear-gradient(145deg,#0f2545,#081a2e);
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
}
.win{border-left:5px solid #4cff8f;}
.loss{border-left:5px solid #ff6b6b;}
.draw{border-left:5px solid #ffd700;}
.small{font-size:12px;color:#aaa;margin-top:4px;}
.empty{text-align:center;opacity:.6;margin-top:20px;}
</style>
</head>

<body>
<div class="container">

<header>
  <img src="logo.png">
  <h2>AFNS Elite Player Profile</h2>
</header>

<div class="card" id="viewBox">
  <div class="name" id="v_username">Loading...</div>
  <div class="email" id="v_email">‚Äî</div>
  <div id="rankBadge" class="rank-badge">Unranked</div>

  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div class="stats">
    <div class="stat"><div>Rating</div><h3 id="rating">0</h3></div>
    <div class="stat"><div>Wins</div><h3 id="wins">0</h3></div>
    <div class="stat"><div>Losses</div><h3 id="losses">0</h3></div>
    <div class="stat"><div>Win Rate</div><h3 id="winRate">0%</h3></div>
  </div>

  <button onclick="toggleHistory(true)">üìú Match History</button>
  <button class="secondary" onclick="logout()">Logout</button>
  <button class="home-btn" onclick="location.href='index.html'">üè† Home</button>
</div>

<div class="match-history hidden" id="matchHistory">
  <h3>üìú Match History</h3>
  <div id="matchList"></div>
  <button class="secondary" onclick="toggleHistory(false)">Close</button>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain: "afnsclub.firebaseapp.com",
  projectId: "afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

let username="";

// AUTH CHECK
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.replace("login.html");
    return;
  }

  const uid=user.uid;
  document.getElementById("v_email").innerText=user.email;

  const playerRef=db.collection("players").doc(uid);
  let doc=await playerRef.get();

  if(!doc.exists){
    await playerRef.set({
      username:user.email.split("@")[0],
      rating:1000,wins:0,losses:0,draws:0
    });
    doc=await playerRef.get();
  }

  const data=doc.data();
  username=data.username;

  document.getElementById("v_username").innerText=data.username;
  document.getElementById("rating").innerText=data.rating||1000;
  document.getElementById("wins").innerText=data.wins||0;
  document.getElementById("losses").innerText=data.losses||0;

  const total=(data.wins||0)+(data.losses||0)+(data.draws||0);
  document.getElementById("winRate").innerText=
    total?Math.round((data.wins/total)*100)+"%":"0%";

  document.getElementById("rankBadge").innerText=
    (data.rating>=2000?"üëë Legend":
     data.rating>=1500?"üî• Elite":
     data.rating>=1000?"‚≠ê Pro":
     "Unranked");

  document.getElementById("progressBar").style.width=
    Math.min((data.rating%500)/5,100)+"%";
});

// MATCH HISTORY
function toggleHistory(show){
  document.getElementById("matchHistory").classList.toggle("hidden",!show);
  document.getElementById("viewBox").classList.toggle("hidden",show);
  if(show) loadMatches();
}

async function loadMatches(){
  const list=document.getElementById("matchList");
  list.innerHTML="";

  const snap=await db.collection("matches")
    .where("status","==","approved")
    .get();

  const myMatches=snap.docs.filter(d=>{
    const m=d.data();
    return m.player1===username||m.player2===username;
  });

  if(myMatches.length===0){
    list.innerHTML=`<div class="empty">No matches played yet</div>`;
    return;
  }

  myMatches
  .sort((a,b)=>{
    const da=a.data().createdAt?.toDate?.()||new Date(0);
    const dbb=b.data().createdAt?.toDate?.()||new Date(0);
    return dbb-da;
  })
  .forEach(d=>{
    const m=d.data();
    const opponent=m.player1===username?m.player2:m.player1;

    let cls="draw",text="DRAW";
    if(m.winner===username){cls="win";text="WIN";}
    else if(m.loser===username){cls="loss";text="LOSS";}

    list.innerHTML+=`
      <div class="match-card ${cls}">
        <b>${text}</b> vs ${opponent}<br>
        Score: ${m.score}
        <div class="small">
          ${m.createdAt?.toDate?.().toLocaleString()||""}
        </div>
      </div>`;
  });
}

function logout(){
  auth.signOut().then(()=>location.replace("login.html"));
}
</script>

</body>
    </html>
