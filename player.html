<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>AFNS Elite Player Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:radial-gradient(circle at top,#1a2f5c 0%,#0b1c33 40%,#1a0f1f 75%,#000 100%);
  color:#fff;
}
.container{max-width:700px;margin:auto;padding:20px;}
header{text-align:center;margin-bottom:20px;}
header img{width:90px;}
.card{
  background:linear-gradient(145deg,#0f2545,#081a2e);
  padding:20px;border-radius:22px;
  box-shadow:0 0 25px rgba(255,215,0,.15),0 0 40px rgba(0,120,255,.15);
}
.name{font-size:22px;font-weight:bold;color:#ffd34d;}
.email{opacity:.85;margin-bottom:8px;}
.rank-badge{
  display:inline-block;padding:6px 14px;border-radius:25px;
  background:linear-gradient(45deg,#ff3b3b,#ffae00);
  color:#fff;font-weight:bold;margin-top:6px;
}
.progress{background:#0c223f;border-radius:10px;overflow:hidden;height:10px;margin:12px 0;}
.progress-bar{height:100%;background:linear-gradient(90deg,#4db8ff,#ffd34d);width:0%;transition:.5s;}
.info-line{margin:8px 0;font-size:14px;}
.info-line span{color:#4db8ff;}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:15px;}
.stat{
  background:linear-gradient(145deg,#132f55,#0d203a);
  padding:14px;border-radius:14px;text-align:center;
}
.stat h3{margin:5px 0;color:#ffd34d;}
button{
  width:100%;padding:12px;margin-top:10px;border:none;
  border-radius:12px;cursor:pointer;font-weight:bold;
  background:linear-gradient(45deg,#1e5eff,#00c6ff);
  color:#fff;
}
button.secondary{background:#1a1a1a;color:#ccc;}
.hidden{display:none;}
input{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;}
.success{color:#00ff88;margin-top:10px;}
.fb-link{color:#4db8ff;text-decoration:underline;cursor:pointer;}
.home-btn{
  background:linear-gradient(45deg,#ff9800,#ff3d00);
}
.match-history{
  margin-top:20px;
}
.match-card{
  background:linear-gradient(145deg,#0f2545,#081a2e);
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  box-shadow:0 0 12px rgba(0,0,0,.5);
}
.win{border-left:5px solid #4cff8f;}
.loss{border-left:5px solid #ff6b6b;}
.draw{border-left:5px solid #ffd700;}
.small{font-size:12px;color:#aaa;margin-top:4px;}
.empty{text-align:center;opacity:.6;margin-top:20px;}
</style>
</head>

<body>
<div class="container">
<header>
  <img src="logo.png" alt="AFNS Logo">
  <h2>AFNS Elite Player Profile</h2>
</header>

<div class="card" id="viewBox">
  <div class="name" id="v_username">Loading...</div>
  <div class="email" id="v_email">‚Äî</div>
  <div id="rankBadge" class="rank-badge">Unranked</div>

  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div class="info-line">üåê Facebook:
    <span id="fbLink" class="fb-link hidden" onclick="openFb()">View Profile</span>
  </div>

  <div class="info-line">üì± Phone: <span id="v_phone">‚Äî</span></div>
  <div class="info-line">üëë Owner ID: <span id="v_ownerId">‚Äî</span></div>
  <div class="info-line">üíª Device: <span id="v_device">‚Äî</span></div>

  <div class="stats">
    <div class="stat"><div>Rating</div><h3 id="rating">0</h3></div>
    <div class="stat"><div>Wins</div><h3 id="wins">0</h3></div>
    <div class="stat"><div>Losses</div><h3 id="losses">0</h3></div>
    <div class="stat"><div>Win Rate</div><h3 id="winRate">0%</h3></div>
  </div>

  <button onclick="location.href='player-submit-match.html'">Submit Match</button>
  <button onclick="toggleHistory(true)">Match History</button>
  <button onclick="toggleEdit(true)">Edit Profile</button>
  <button class="secondary" onclick="logout()">Logout</button>
  <button class="home-btn" onclick="location.href='index.html'">üè† Home</button>
</div>

<div id="editBox" class="hidden">
  <input id="phone" placeholder="Phone">
  <input id="ownerId" placeholder="Owner ID">
  <input id="facebook" placeholder="Facebook link">
  <input id="deviceName" placeholder="Device name">
  <button onclick="saveProfile()">Save</button>
  <button class="secondary" onclick="toggleEdit(false)">Cancel</button>
</div>

<div class="match-history hidden" id="matchHistory">
  <h3>üìú Match History</h3>
  <div id="matchList"></div>
  <button class="secondary" onclick="toggleHistory(false)">Close History</button>
</div>

<div id="msg"></div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain: "afnsclub.firebaseapp.com",
  projectId: "afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();
let uid, fbUrl="", username="";

// AUTH CHECK
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.replace("login.html");
    return;
  }
  uid = user.uid;

  const docRef = db.collection("players").doc(uid);
  let docSnap = await docRef.get();

  username = docSnap.data()?.username || user.email.split("@")[0];

  document.getElementById("v_email").innerText = user.email;

  if(!docSnap.exists){
    await docRef.set({
      username: username,
      rating: 1000,
      wins: 0,
      losses: 0,
      draws: 0,
      phone: "",
      ownerId: "",
      facebook: "",
      deviceName: ""
    });
  }

  db.collection("players").doc(uid).onSnapshot(doc=>{
    if(!doc.exists) return;
    const d = doc.data();

    document.getElementById("v_username").innerText = d.username || "‚Äî";
    document.getElementById("v_phone").innerText = d.phone || "‚Äî";
    document.getElementById("v_ownerId").innerText = d.ownerId || "‚Äî";
    document.getElementById("v_device").innerText = d.deviceName || "‚Äî";

    fbUrl = d.facebook || "";
    document.getElementById("fbLink").classList.toggle("hidden", !fbUrl);

    const rating = d.rating || 1000;
    const wins = d.wins || 0;
    const losses = d.losses || 0;
    const draws = d.draws || 0;

    document.getElementById("rating").innerText = rating;
    document.getElementById("wins").innerText = wins;
    document.getElementById("losses").innerText = losses;

    const total = wins + losses + draws;
    const winRate = total ? Math.round((wins/total)*100) : 0;
    document.getElementById("winRate").innerText = winRate + "%";

    document.getElementById("rankBadge").innerText =
      rating>=2000?"üëë Legend":
      rating>=1500?"üî• Elite":
      rating>=1000?"‚≠ê Pro":
      rating>=500?"ü•â Rising":"Unranked";

    let progressWidth = Math.min(100, (rating%500)/5);
    document.getElementById("progressBar").style.width = progressWidth + "%";
  });

});

// EDIT PROFILE
function toggleEdit(edit){
  document.getElementById("viewBox").classList.toggle("hidden", edit);
  document.getElementById("editBox").classList.toggle("hidden", !edit);
}

function saveProfile(){
  db.collection("players").doc(uid).update({
    phone: document.getElementById("phone").value.trim(),
    ownerId: document.getElementById("ownerId").value.trim(),
    facebook: document.getElementById("facebook").value.trim(),
    deviceName: document.getElementById("deviceName").value.trim()
  }).then(()=>{
    document.getElementById("msg").innerHTML =
      "<div class='success'>Profile Updated</div>";
    toggleEdit(false);
  });
}

function openFb(){
  if(fbUrl) window.open(fbUrl,"_blank");
}

function logout(){
  auth.signOut().then(()=>{location.replace("login.html");});
}

// MATCH HISTORY
function toggleHistory(show){
  document.getElementById("matchHistory").classList.toggle("hidden", !show);
  document.getElementById("viewBox").classList.toggle("hidden", show);

  if(show) loadMatchHistory();
}

async function loadMatchHistory(){
  const listDiv = document.getElementById("matchList");
  listDiv.innerHTML = "";

  const snap = await db.collection("matches")
    .where("player1","==",username)
    .where("status","==","approved")
    .get();

  const snap2 = await db.collection("matches")
    .where("player2","==",username)
    .where("status","==","approved")
    .get();

  const allMatches = [...snap.docs, ...snap2.docs]
    .sort((a,b)=>{
      const aTime = a.data().createdAt?.toDate()?.getTime() || 0;
      const bTime = b.data().createdAt?.toDate()?.getTime() || 0;
      return bTime - aTime;
    });

  if(allMatches.length===0){
    listDiv.innerHTML = `<div class="empty">No matches played yet</div>`;
    return;
  }

  allMatches.forEach(d=>{
    const m = d.data();
    const opponent = m.player1===username ? m.player2 : m.player1;
    let resultClass = "draw";
    if(m.resultType?.toLowerCase() === "win"){
      if(m.winner === username) resultClass="win";
      else if(m.loser === username) resultClass="loss";
    }

    listDiv.innerHTML += `
      <div class="match-card ${resultClass}">
        <b>${m.resultType.toUpperCase()}</b> vs ${opponent}<br>
        Score: ${m.score}
        ${m.tournamentName ? `<div class="small">Tournament: ${m.tournamentName}</div>` : ``}
        <div class="small">
          ${m.createdAt?.toDate().toLocaleString() || ""}
        </div>
      </div>
    `;
  });
}
</script>

</body>
</html>
