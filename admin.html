<script type="module">
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  onSnapshot,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE INIT */
const firebaseConfig = {
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* âœ… OWNER / ADMINS (EMAIL BASED) */
const ADMIN_EMAILS = [
  "sisaif167@gmail.com"
];

/* ðŸ” AUTH GUARD */
onAuthStateChanged(auth, user => {
  if (!user) {
    location.replace("admin-login.html");
    return;
  }

  if (!ADMIN_EMAILS.includes(user.email)) {
    signOut(auth).then(() => {
      location.replace("admin-login.html");
    });
    return;
  }

  // âœ… ADMIN OK
  adminRole.innerText = "ðŸ‘‘ OWNER";
  loadDashboard();
});

/* ðŸ”¹ LOAD DASHBOARD DATA */
function loadDashboard(){

  // ðŸ”” Activity
  onSnapshot(
    query(collection(db,"activity"), orderBy("time","desc"), limit(5)),
    snap=>{
      alertsBox.innerHTML="";
      if(snap.empty){
        alertsBox.innerHTML="<div class='alert-item'>No activity</div>";
      }
      snap.forEach(d=>{
        const a=d.data();
        alertsBox.innerHTML+=
          `<div class="alert-item">â€¢ ${a.type} by ${a.by}</div>`;
      });
    }
  );

  // ðŸ¤– AI Escalation
  onSnapshot(
    query(collection(db,"adminAlerts"), orderBy("time","desc"), limit(5)),
    snap=>{
      snap.forEach(d=>{
        alertsBox.innerHTML+=
          `<div class="alert-item">ðŸ¤– AI Escalation â€¢ ${d.data().uid}</div>`;
      });
    }
  );

  // ðŸ“Š Stats
  onSnapshot(collection(db,"players"), s=>players.innerText=s.size);
  onSnapshot(collection(db,"matches"), s=>matches.innerText=s.size);
  onSnapshot(collection(db,"admins"), s=>admins.innerText=s.size);

  // ðŸ” Permissions (OWNER = ALL)
  document.querySelectorAll("[class*='perm-']").forEach(el=>{
    el.style.display="block";
  });

  permBox.innerHTML="âœ” Full Owner Access";
}

/* ðŸšª LOGOUT */
window.logout = function(){
  signOut(auth).then(()=>{
    location.replace("admin-login.html");
  });
}

/* ðŸ” NAV */
window.go = p => location.href=p;
</script>
