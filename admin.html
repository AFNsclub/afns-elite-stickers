<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  onSnapshot,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE INIT */
const firebaseConfig = {
  apiKey: "AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain: "afnsclub.firebaseapp.com",
  projectId: "afnsclub"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ðŸ” AUTH GUARD (ROLE BASED) */
onAuthStateChanged(auth, async user => {
  if (!user) {
    location.replace("admin-login.html");
    return;
  }

  const adminRef  = doc(db, "admins", user.uid);
  const adminSnap = await getDoc(adminRef);

  if (!adminSnap.exists() || adminSnap.data().active !== true) {
    await signOut(auth);
    location.replace("admin-login.html");
    return;
  }

  const admin = adminSnap.data();
  const role  = admin.role || "admin";

  // ðŸ”° ROLE LABEL
  adminRole.innerText =
    role === "owner"   ? "ðŸ‘‘ OWNER" :
    role === "admin"   ? "ðŸ›¡ï¸ ADMIN" :
    role === "manager" ? "ðŸ“‹ MANAGER" :
    role === "captain" ? "ðŸŽ½ CAPTAIN" :
    "USER";

  applyPermissions(admin.permissions || {}, role);
  loadDashboard();
});

/* ðŸ” PERMISSION HANDLER */
function applyPermissions(perms, role) {
  document.querySelectorAll("[class^='perm-']").forEach(el => {
    const key = el.dataset.perm;
    el.style.display = (role === "owner" || perms[key]) ? "block" : "none";
  });

  permBox.innerText =
    role === "owner"
      ? "âœ” Full Owner Access"
      : "âœ” Limited Admin Access";
}

/* ðŸ“Š DASHBOARD DATA */
function loadDashboard() {

  // ðŸ”” ACTIVITY
  onSnapshot(
    query(collection(db, "activity"), orderBy("time", "desc"), limit(5)),
    snap => {
      alertsBox.innerHTML = "";
      if (snap.empty) {
        alertsBox.innerHTML = "<div class='alert-item'>No activity</div>";
      }
      snap.forEach(d => {
        const a = d.data();
        alertsBox.innerHTML +=
          `<div class="alert-item">â€¢ ${a.type} by ${a.by}</div>`;
      });
    }
  );

  // ðŸ¤– AI ALERTS
  onSnapshot(
    query(collection(db, "adminAlerts"), orderBy("time", "desc"), limit(5)),
    snap => {
      snap.forEach(d => {
        alertsBox.innerHTML +=
          `<div class="alert-item">ðŸ¤– AI Alert â€¢ ${d.data().uid}</div>`;
      });
    }
  );

  // ðŸ“ˆ STATS
  onSnapshot(collection(db, "players"), s => players.innerText = s.size);
  onSnapshot(collection(db, "matches"), s => matches.innerText = s.size);
  onSnapshot(collection(db, "admins"),  s => admins.innerText  = s.size);
}

/* ðŸšª LOGOUT */
window.logout = async function () {
  await signOut(auth);
  location.replace("admin-login.html");
};

/* ðŸ” NAV */
window.go = page => location.href = page;
    </script>
