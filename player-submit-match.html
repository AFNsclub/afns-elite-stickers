<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial,sans-serif;background:#0d1117;color:#fff;}
.container{max-width:420px;margin:40px auto;padding:20px;}
.card{background:#161b22;border-radius:16px;padding:20px;box-shadow:0 0 20px #000;}
.avatar{width:80px;height:80px;border-radius:50%;background:#22c55e;color:#000;font-size:32px;font-weight:bold;display:flex;align-items:center;justify-content:center;margin:auto;}
.name{text-align:center;font-size:22px;font-weight:bold;margin-top:10px;}
.rank{text-align:center;margin-top:5px;color:#facc15;font-weight:bold;}
.info{margin-top:20px;font-size:14px;}
.info div{margin:6px 0;color:#c9d1d9;}
.stats{display:flex;justify-content:space-between;margin-top:20px;}
.stat{background:#0d1117;border-radius:12px;padding:10px;width:30%;text-align:center;}
.stat h3{margin:0;font-size:20px;color:#58a6ff;}
.stat span{font-size:12px;color:#8b949e;}
.footer{margin-top:20px;text-align:center;font-size:13px;}
.footer a{color:#58a6ff;text-decoration:none;}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="avatar" id="avatar">A</div>
    <div class="name" id="name">Player Name</div>
    <div class="rank" id="rank">ğŸ† Rank #</div>
    <div class="info">
      <div>ğŸ“± Device: <span id="device"></span></div>
      <div>ğŸ“ Mobile: <span id="mobile"></span></div>
      <div>ğŸ“§ Gmail: <span id="email"></span></div>
      <div>ğŸ® Owner / Game ID: <span id="gameid"></span></div>
      <div>ğŸ”— <a id="facebook" href="#" target="_blank">Facebook Profile</a></div>
    </div>
    <div class="stats">
      <div class="stat"><h3 id="win">0</h3><span>Wins</span></div>
      <div class="stat"><h3 id="lose">0</h3><span>Loses</span></div>
      <div class="stat"><h3 id="gd">0</h3><span>Goal Diff</span></div>
    </div>
    <div class="footer">âš½ Goals: <span id="gf">0</span> - <span id="ga">0</span></div>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase-init.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

onAuthStateChanged(auth, async user=>{
  if(!user){ alert("Please login first"); return; }

  const userSnap = await getDoc(doc(db,"players",user.uid));
  if(!userSnap.exists()){ alert("Player data not found!"); return; }
  const p = userSnap.data();

  document.title = p.username + " | Profile";
  document.getElementById("avatar").innerText = p.username.charAt(0).toUpperCase();
  document.getElementById("name").innerText = p.username;
  document.getElementById("device").innerText = p.deviceName || "-";
  document.getElementById("mobile").innerText = p.phone || "-";
  document.getElementById("email").innerText = p.email || "-";
  document.getElementById("gameid").innerText = p.gameId || "-";
  document.getElementById("facebook").href = p.facebook || "#";

  // âœ… Calculate stats from all approved matches
  const matchSnap = await getDocs(query(collection(db,"matches"), where("status","==","approved")));
  let wins=0, losses=0, draws=0, gf=0, ga=0;
  matchSnap.forEach(doc=>{
    const m = doc.data();
    const [s1,s2] = m.score.split("-").map(Number);
    if(m.player1===p.username){
      gf += s1; ga += s2;
      if(s1>s2) wins++;
      else if(s1<s2) losses++;
      else draws++;
    } else if(m.player2===p.username){
      gf += s2; ga += s1;
      if(s2>s1) wins++;
      else if(s2<s1) losses++;
      else draws++;
    }
  });

  document.getElementById("win").innerText = wins;
  document.getElementById("lose").innerText = losses;
  document.getElementById("gd").innerText = gf - ga;
  document.getElementById("gf").innerText = gf;
  document.getElementById("ga").innerText = ga;

  // ğŸ”¥ Rank by rating
  const snapPlayers = await getDocs(collection(db,"players"));
  let list = [];
  snapPlayers.forEach(d=>{ const x=d.data(); list.push({id:d.id,rating:x.rating||1000}); });
  list.sort((a,b)=>b.rating-a.rating);
  const rank = list.findIndex(x=>x.id===user.uid)+1;
  document.getElementById("rank").innerText = "ğŸ† Rank #" + rank + " | â­ Rating: " + (p.rating||1000);
});
</script>
</body>
</html>
