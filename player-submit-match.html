<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Submit Match</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#050b1e;
  color:#fff;
  font-family:sans-serif;
}
.box{
  max-width:420px;
  margin:30px auto;
  background:#0b1622;
  padding:20px;
  border-radius:16px;
}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
}
button{
  background:#4f8cff;
  font-weight:700;
  color:#fff;
}
.list{
  background:#0f1a28;
  border-radius:10px;
  margin-top:5px;
  overflow:hidden;
}
.item{
  padding:10px;
  cursor:pointer;
}
.item:hover{
  background:#1b2a40;
}
#msg{
  margin-top:12px;
  font-size:14px;
}
</style>
</head>

<body>

<div class="box">
  <h2>⚔️ Submit Match</h2>

  <input id="opponentSearch" placeholder="Opponent name">
  <div id="opponentList" class="list"></div>

  <select id="matchType">
    <option value="friendly">Friendly</option>
    <option value="tournament">Tournament</option>
  </select>

  <input id="tournamentName" placeholder="Tournament name" style="display:none">
  <input id="score" placeholder="Score (ex: 3-1)">

  <button onclick="submitMatch()">Submit</button>
  <div id="msg"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let opponentId = null;

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="login.html";
    return;
  }
  currentUser = user;
});

/* TOURNAMENT TOGGLE */
matchType.onchange = ()=>{
  tournamentName.style.display =
    matchType.value==="tournament" ? "block" : "none";
};

/* AUTOCOMPLETE DROPDOWN */
opponentSearch.oninput = async ()=>{
  const q = opponentSearch.value.trim().toLowerCase();
  opponentList.innerHTML = "";
  opponentId = null;

  if(q.length < 2) return;

  const snap = await db.collection("players")
    .where("usernameLower", ">=", q)
    .where("usernameLower", "<=", q + "\uf8ff")
    .limit(6)
    .get();

  snap.forEach(doc=>{
    if(doc.id === currentUser.uid) return;

    const div = document.createElement("div");
    div.className = "item";
    div.textContent = doc.data().username;

    div.onclick = ()=>{
      opponentId = doc.id;
      opponentSearch.value = doc.data().username;
      opponentList.innerHTML = "";
    };

    opponentList.appendChild(div);
  });
};

/* SUBMIT MATCH */
async function submitMatch(){
  msg.textContent = "";

  if(!opponentId){
    msg.textContent = "❌ Please select opponent from list";
    return;
  }
  if(!score.value){
    msg.textContent = "❌ Enter match score";
    return;
  }
  if(matchType.value==="tournament" && !tournamentName.value){
    msg.textContent = "❌ Enter tournament name";
    return;
  }

  await db.collection("matches_pending").add({
    playerId: currentUser.uid,
    opponentId: opponentId,
    matchType: matchType.value,
    tournamentName: matchType.value==="tournament" ? tournamentName.value : null,
    score: score.value,
    submittedBy: currentUser.uid,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  msg.textContent = "✅ Match submitted (waiting for admin approval)";
  opponentSearch.value="";
  score.value="";
  tournamentName.value="";
}
</script>

</body>
</html>
