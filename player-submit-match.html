<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Submit Match | AFNS Elite Strikers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body{margin:0;font-family:Arial;background:#0b1220;color:white;}
.container{max-width:400px;margin:50px auto;padding:20px;background:#141c2f;border-radius:12px;}
h2{text-align:center;color:#00eaff;}
label{display:block;margin-top:15px;}
input,select,button{width:100%;padding:12px;margin-top:6px;border:none;border-radius:8px;}
input,select{background:#0b1220;color:white;}
button{background:#00eaff;color:black;font-weight:bold;margin-top:20px;}
.searchBox{position:relative;}
.dropdown{position:absolute;width:100%;background:#1a2438;max-height:150px;overflow-y:auto;border-radius:8px;z-index:1000;}
.dropdown div{padding:10px;cursor:pointer;}
.dropdown div:hover{background:#00eaff;color:black;}
</style>
</head>
<body>
<div class="container">
<h2>Submit Match</h2>

<label>Player 1</label>
<div class="searchBox">
  <input type="text" id="player1" onkeyup="filterPlayers('player1')" autocomplete="off">
  <div class="dropdown" id="player1List"></div>
</div>

<label>Player 2</label>
<div class="searchBox">
  <input type="text" id="player2" onkeyup="filterPlayers('player2')" autocomplete="off">
  <div class="dropdown" id="player2List"></div>
</div>

<label>Score (Example: 3-3)</label>
<input type="text" id="score">

<label>Match Type</label>
<select id="matchType" onchange="toggleTournament()">
<option value="friendly">Friendly</option>
<option value="tournament">Tournament</option>
</select>

<div id="tournamentBox" style="display:none;">
  <label>Tournament Name</label>
  <input type="text" id="tournamentName">
</div>

<button onclick="submitMatch()">Submit Match</button>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});
const auth = firebase.auth();
const db = firebase.firestore();
let allPlayers=[];

auth.onAuthStateChanged(user=>{
  if(!user){location.href="login.html";}else{loadPlayers();}
});

async function loadPlayers(){
  const snap = await db.collection("players").get();
  snap.forEach(doc=>allPlayers.push(doc.data().username || doc.id));
}

function filterPlayers(type){
  const input=document.getElementById(type);
  const list=document.getElementById(type+"List");
  const value=input.value.toLowerCase();
  list.innerHTML="";
  if(value.length<1) return;
  const filtered=allPlayers.filter(name=>name.toLowerCase().includes(value)).slice(0,10);
  filtered.forEach(name=>{
    const div=document.createElement("div");
    div.textContent=name;
    div.onclick=()=>{input.value=name;list.innerHTML="";};
    list.appendChild(div);
  });
}

function toggleTournament(){
  document.getElementById("tournamentBox").style.display = matchType.value==="tournament"?"block":"none";
}

async function submitMatch(){
  const user = auth.currentUser;
  const p1 = player1.value.trim();
  const p2 = player2.value.trim();
  const scoreVal = score.value.trim();
  const type = matchType.value;
  const tName = tournamentName.value.trim();

  if(!p1||!p2||!scoreVal){alert("All fields required!");return;}
  if(p1===p2){alert("Players cannot be same!");return;}
  if(!scoreVal.includes("-")){alert("Invalid score format");return;}

  let resultType="draw", winner=null, loser=null;
  const parts=scoreVal.split("-").map(Number);
  if(parts[0]>parts[1]){winner=p1;loser=p2;resultType="win";}
  else if(parts[1]>parts[0]){winner=p2;loser=p1;resultType="win";}

  await db.collection("matches").doc(Date.now().toString()).set({
    player1:p1, player2:p2, score:scoreVal,
    resultType, winner, loser,
    matchType:type,
    tournamentName:type==="tournament"?tName:null,
    submittedBy:user.email,
    status:"pending",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Match submitted for approval!");
  location.reload();
}
</script>
</body>
</html>
