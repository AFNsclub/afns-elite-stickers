<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Match | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#050b1e;color:#fff;font-family:Segoe UI,sans-serif}
.container{max-width:440px;margin:40px auto;padding:20px;background:#0b1622;border-radius:16px}
h2{text-align:center;color:#4f8cff}
input,select,button{width:100%;padding:12px;margin-top:12px;border-radius:10px;border:none}
button{background:#4f8cff;font-weight:700;cursor:pointer}
.success{color:#4cff8f;margin-top:10px}
.error{color:#ff6b6b;margin-top:10px}
</style>
</head>

<body>
<div class="container">
<h2>‚öîÔ∏è Add Match Result</h2>

<input id="playerId" placeholder="Player UID">
<select id="result">
  <option value="win">Win</option>
  <option value="loss">Loss</option>
</select>
<input id="opponent" placeholder="Opponent">
<input id="score" placeholder="Score (ex: 3-1)">
<button onclick="addMatch()">Add Match</button>
<div id="msg"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const db=firebase.firestore();

/* ===============================
   RANK SYSTEM
=============================== */
function getRank(r){
  if(r>=200) return "Legend üî•";
  if(r>=150) return "Platinum üîµ";
  if(r>=100) return "Gold üü°";
  if(r>=50) return "Silver ‚ö™";
  return "Bronze üü§";
}

/* ===============================
   CURRENT SEASON (AUTO)
=============================== */
async function getCurrentSeason(){
  const q=await db.collection("seasons").where("active","==",true).limit(1).get();
  if(!q.empty) return {id:q.docs[0].id,...q.docs[0].data()};

  const now=new Date();
  const seasonId=`${now.getFullYear()}-S1`;

  await db.collection("seasons").doc(seasonId).set({
    name:`${now.getFullYear()} Season 1`,
    start:firebase.firestore.Timestamp.now(),
    active:true
  });

  return {id:seasonId};
}

/* ===============================
   ADD MATCH + ROLLBACK DATA
=============================== */
async function addMatch(){
  msg.innerHTML="";
  const uid=playerId.value.trim();
  if(!uid) return msg.innerHTML="<div class='error'>Player UID required</div>";

  const season=await getCurrentSeason();
  const ref=db.collection("players").doc(uid);

  try{
    await db.runTransaction(async(t)=>{
      const snap=await t.get(ref);
      if(!snap.exists) throw "Player not found";

      const d=snap.data();
      const before={
        rating:d.rating||50,
        wins:d.wins||0,
        losses:d.losses||0,
        rank:d.rank||"Bronze"
      };

      let rating=before.rating;
      let wins=before.wins;
      let losses=before.losses;

      if(result.value==="win"){rating+=10;wins++;}
      else{rating=Math.max(50,rating-5);losses++;}

      t.update(ref,{
        rating,wins,losses,
        rank:getRank(rating),
        seasonId:season.id
      });

      t.set(db.collection("matches").doc(),{
        playerId:uid,
        opponent:opponent.value,
        result:result.value,
        score:score.value,
        seasonId:season.id,
        time:firebase.firestore.FieldValue.serverTimestamp(),
        before,
        editable:true
      });
    });

    msg.innerHTML="<div class='success'>‚úÖ Match added + rollback safe</div>";
  }catch(e){
    msg.innerHTML="<div class='error'>‚ùå "+e+"</div>";
  }
}
</script>
</body>
</html>
