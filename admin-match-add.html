<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Match | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#050b1e;color:#fff;font-family:Segoe UI,sans-serif}
.container{max-width:440px;margin:40px auto;padding:20px;background:#0b1622;border-radius:16px}
h2{text-align:center;color:#4f8cff}
input,select,button{width:100%;padding:12px;margin-top:12px;border-radius:10px;border:none}
button{background:#4f8cff;font-weight:700;cursor:pointer}
.success{color:#4cff8f;margin-top:10px}
.error{color:#ff6b6b;margin-top:10px}
</style>
</head>

<body>
<div class="container">
<h2>‚öîÔ∏è Add Match Result</h2>

<input id="playerId" placeholder="Player UID">
<select id="result">
  <option value="win">Win</option>
  <option value="loss">Loss</option>
</select>
<input id="opponent" placeholder="Opponent">
<input id="score" placeholder="Score (ex: 3-1)">
<button onclick="addMatch()">Add Match</button>
<div id="msg"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const db=firebase.firestore();

/* ===============================
   RANK SYSTEM
=============================== */
function getRank(r){
  if(r>=200) return "Legend üî•";
  if(r>=150) return "Platinum üîµ";
  if(r>=100) return "Gold üü°";
  if(r>=50)  return "Silver ‚ö™";
  return "Bronze üü§";
}

/* ===============================
   CURRENT ACTIVE SEASON
=============================== */
async function getCurrentSeason(){
  const q=await db.collection("seasons")
    .where("active","==",true)
    .limit(1)
    .get();

  if(!q.empty){
    return {id:q.docs[0].id,...q.docs[0].data()};
  }

  // fallback (should not normally happen)
  const year=new Date().getFullYear();
  const id=`${year}-S1`;

  await db.collection("seasons").doc(id).set({
    name:`${year} Season 1`,
    active:true,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  return {id};
}

/* ===============================
   ADD MATCH (ROLLBACK SAFE)
=============================== */
async function addMatch(){
  msg.innerHTML="";
  const uid=playerId.value.trim();

  if(!uid){
    msg.innerHTML="<div class='error'>Player UID required</div>";
    return;
  }

  try{
    const season=await getCurrentSeason();
    const playerRef=db.collection("players").doc(uid);

    await db.runTransaction(async(t)=>{
      const snap=await t.get(playerRef);
      if(!snap.exists) throw "Player not found";

      const d=snap.data();

      /* BEFORE STATE (for rollback) */
      const before={
        rating: d.rating ?? 50,
        wins: d.wins ?? 0,
        losses: d.losses ?? 0,
        rank: d.rank ?? "Bronze üü§"
      };

      let rating = before.rating;
      let wins   = before.wins;
      let losses = before.losses;

      if(result.value==="win"){
        rating += 10;
        wins++;
      }else{
        rating = Math.max(50, rating-5);
        losses++;
      }

      const newRank = getRank(rating);

      /* UPDATE PLAYER */
      t.update(playerRef,{
        rating,
        wins,
        losses,
        rank:newRank,
        seasonId:season.id,
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      });

      /* SAVE MATCH (rollback ready) */
      t.set(db.collection("matches").doc(),{
        playerId: uid,
        opponent: opponent.value,
        result: result.value,
        score: score.value,
        seasonId: season.id,

        ratingBefore: before.rating,
        winsBefore: before.wins,
        lossesBefore: before.losses,
        rankBefore: before.rank,

        ratingAfter: rating,
        rankAfter: newRank,

        editable: true,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    msg.innerHTML="<div class='success'>‚úÖ Match added (Rollback safe)</div>";
  }catch(e){
    msg.innerHTML="<div class='error'>‚ùå "+e+"</div>";
  }
}
</script> 
<script src="season-manager.js"></script>
</body>
</html>
