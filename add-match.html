<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  doc,
  updateDoc,
  increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});
  
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ======================
   üë§ ELEMENTS
====================== */
const p1Input = document.getElementById("player1");
const p2Input = document.getElementById("player2");
const p1List = document.getElementById("player1List");
const p2List = document.getElementById("player2List");

const resultSelect = document.getElementById("result");
const matchTypeSelect = document.getElementById("matchType");
const scoreInput = document.getElementById("score");
const addBtn = document.getElementById("addMatchBtn");
const errorBox = document.getElementById("errorBox");

/* ======================
   üì¶ STATE
====================== */
let allPlayers = [];
let selectedP1 = null;
let selectedP2 = null;

/* ======================
   üîê AUTH CHECK
====================== */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "/login.html";
  }
});

/* ======================
   üì• LOAD PLAYERS
====================== */
async function loadPlayers() {
  const snap = await getDocs(collection(db, "players"));
  allPlayers = [];
  snap.forEach(docSnap => {
    allPlayers.push({
      id: docSnap.id,
      ...docSnap.data()
    });
  });
}
loadPlayers();

/* ======================
   üîç SEARCH HELPERS
====================== */
function renderList(input, listEl, isPlayer1) {
  listEl.innerHTML = ""; // ‚úÖ DUPLICATE FIX

  const q = input.value.toLowerCase();
  if (!q) return;

  allPlayers
    .filter(p => p.usernameLower?.includes(q))
    .slice(0, 6)
    .forEach(player => {
      const div = document.createElement("div");
      div.textContent = player.username;
      div.className = "search-item";
      div.onclick = () => {
        input.value = player.username;
        listEl.innerHTML = "";

        if (isPlayer1) selectedP1 = player;
        else selectedP2 = player;
      };
      listEl.appendChild(div);
    });
}

/* ======================
   üîç INPUT EVENTS
====================== */
p1Input.addEventListener("input", () =>
  renderList(p1Input, p1List, true)
);

p2Input.addEventListener("input", () =>
  renderList(p2Input, p2List, false)
);

/* ======================
   ‚öîÔ∏è ADD MATCH
====================== */
addBtn.addEventListener("click", async () => {
  errorBox.textContent = "";

  if (!selectedP1 || !selectedP2) {
    errorBox.textContent = "‚ùå Player 1 ‡¶è‡¶¨‡¶Ç Player 2 ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã";
    return;
  }

  if (selectedP1.id === selectedP2.id) {
    errorBox.textContent = "‚ùå ‡¶è‡¶ï‡¶á player ‡¶¶‡ßÅ‡¶á‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ";
    return;
  }

  try {
    const result = resultSelect.value;
    const score = scoreInput.value.trim();

    /* ======================
       üìù MATCH DATA
    ====================== */
    await addDoc(collection(db, "matches"), {
      player1Id: selectedP1.id,
      player1Name: selectedP1.username,
      player2Id: selectedP2.id,
      player2Name: selectedP2.username,
      result,
      score,
      matchType: matchTypeSelect.value,
      createdAt: new Date()
    });

    /* ======================
       üìä PLAYER UPDATES
    ====================== */
    const p1Ref = doc(db, "players", selectedP1.id);
    const p2Ref = doc(db, "players", selectedP2.id);

    if (result === "Win") {
      await updateDoc(p1Ref, {
        wins: increment(1),
        matches: increment(1)
      });
      await updateDoc(p2Ref, {
        losses: increment(1),
        matches: increment(1)
      });
    } else if (result === "Lose") {
      await updateDoc(p1Ref, {
        losses: increment(1),
        matches: increment(1)
      });
      await updateDoc(p2Ref, {
        wins: increment(1),
        matches: increment(1)
      });
    } else {
      await updateDoc(p1Ref, { matches: increment(1) });
      await updateDoc(p2Ref, { matches: increment(1) });
    }

    /* ======================
       ‚úÖ RESET UI
    ====================== */
    p1Input.value = "";
    p2Input.value = "";
    scoreInput.value = "";
    selectedP1 = null;
    selectedP2 = null;

    alert("‚úÖ Match added successfully");

  } catch (err) {
    console.error(err);
    errorBox.textContent = "‚ùå Permission ‡¶¨‡¶æ data error ‡¶π‡ßü‡ßá‡¶õ‡ßá";
  }
});
</script>
