<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Match | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#050b1e;color:#fff;font-family:Segoe UI,sans-serif}
.container{max-width:440px;margin:40px auto;padding:20px;background:#0b1622;border-radius:16px}
h2{text-align:center;color:#4f8cff}
input,select,button{width:100%;padding:12px;margin-top:12px;border-radius:10px;border:none}
button{background:#4f8cff;font-weight:700;cursor:pointer}
button[disabled]{background:#333}
.list{background:#111;border-radius:10px;margin-top:6px}
.item{padding:8px;cursor:pointer}
.item:hover{background:#222}
.success{color:#4cff8f;margin-top:12px}
.error{color:#ff6b6b;margin-top:12px}
</style>
</head>

<body>
<div class="container">
<h2>‚öîÔ∏è Add Match Result</h2>

<input id="playerSearch" placeholder="Search player">
<div id="playerList" class="list"></div>

<input id="opponentSearch" placeholder="Search opponent">
<div id="opponentList" class="list"></div>

<select id="result">
  <option value="win">Win</option>
  <option value="loss">Loss</option>
</select>

<select id="matchType">
  <option value="friendly">Friendly</option>
  <option value="tournament">Tournament</option>
</select>

<input id="tournamentName" placeholder="Tournament name" style="display:none">
<input id="score" placeholder="Score (ex: 3-1)">

<button id="addBtn">Add Match</button>
<div id="msg"></div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth=firebase.auth();
const db=firebase.firestore();

let CAN_EDIT=false;
let playerId=null;
let opponentId=null;

/* ================= AUTH ================= */
auth.onAuthStateChanged(async user=>{
  if(!user){ location.href="admin-login.html"; return; }

  const a=await db.collection("admins").doc(user.uid).get();
  if(!a.exists || !a.data().permissions?.editMatch){
    msg.innerHTML="<div class='error'>‚ùå Permission denied</div>";
    addBtn.disabled=true;
    return;
  }
  CAN_EDIT=true;
});

/* ================= UI ================= */
matchType.onchange=()=>{
  tournamentName.style.display=
    matchType.value==="tournament"?"block":"none";
};

/* ================= AUTOCOMPLETE ================= */
function autoComplete(input,list,setter){
  input.oninput=async()=>{
    const q=input.value.toLowerCase();
    list.innerHTML="";
    if(q.length<2) return;

    const snap=await db.collection("players")
      .where("usernameLower",">=",q)
      .where("usernameLower","<=",q+"\uf8ff")
      .limit(6).get();

    snap.forEach(d=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerText=d.data().username;
      div.onclick=()=>{
        setter(d.id);
        input.value=d.data().username;
        list.innerHTML="";
      };
      list.appendChild(div);
    });
  };
}

autoComplete(playerSearch,playerList,id=>playerId=id);
autoComplete(opponentSearch,opponentList,id=>opponentId=id);

/* ================= RANK ================= */
function getRank(r){
  if(r>=200) return "Legend üî•";
  if(r>=150) return "Platinum üîµ";
  if(r>=100) return "Gold üü°";
  if(r>=50)  return "Silver ‚ö™";
  return "Bronze üü§";
}

/* ================= SEASON ================= */
async function getSeason(){
  const q=await db.collection("seasons")
    .where("active","==",true).limit(1).get();

  if(!q.empty) return q.docs[0].id;

  const y=new Date().getFullYear();
  const id=`${y}-S1`;
  await db.collection("seasons").doc(id).set({
    name:`${y} Season 1`,
    active:true,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  return id;
}

/* ================= ADD MATCH ================= */
addBtn.onclick=async()=>{
  if(!CAN_EDIT) return;

  msg.innerHTML="";
  if(!playerId || !opponentId){
    msg.innerHTML="<div class='error'>Select both players</div>";
    return;
  }
  if(playerId===opponentId){
    msg.innerHTML="<div class='error'>Same player not allowed</div>";
    return;
  }

  try{
    const seasonId=await getSeason();
    const pRef=db.collection("players").doc(playerId);

    await db.runTransaction(async t=>{
      const pSnap=await t.get(pRef);
      if(!pSnap.exists) throw "Player not found";

      let {rating=50,wins=0,losses=0}=pSnap.data();

      if(result.value==="win"){ rating+=10; wins++; }
      else{ rating=Math.max(50,rating-5); losses++; }

      const rank=getRank(rating);

      t.update(pRef,{
        rating,wins,losses,rank,
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      });

      t.set(db.collection("matches").doc(),{
        playerId,
        opponentId,
        result:result.value,
        score:score.value,
        matchType:matchType.value,
        tournamentName:matchType.value==="tournament"?tournamentName.value:null,
        seasonId,
        ratingAfter:rating,
        rankAfter:rank,
        addedBy:"admin",
        time:firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    msg.innerHTML="<div class='success'>‚úÖ Match added successfully</div>";
  }catch(e){
    msg.innerHTML="<div class='error'>‚ùå "+e+"</div>";
  }
};
</script>
</body>
</html>
