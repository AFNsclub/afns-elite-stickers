<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Match</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:sans-serif;
  padding:20px;
}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:none;
}
button{
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
.search-list{
  background:#020617;
  border:1px solid #334155;
  max-height:160px;
  overflow:auto;
}
.search-item{
  padding:8px;
  cursor:pointer;
}
.search-item:hover{
  background:#1e293b;
}
#errorBox{
  color:#ff6b6b;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>‚ûï Add Match</h2>

<label>Player 1</label>
<input id="player1" autocomplete="off">
<div id="player1List" class="search-list"></div>

<label>Player 2</label>
<input id="player2" autocomplete="off">
<div id="player2List" class="search-list"></div>

<label>Result</label>
<select id="result">
  <option value="Win">Player 1 Win</option>
  <option value="Lose">Player 1 Lose</option>
  <option value="Draw">Draw</option>
</select>

<label>Match Type</label>
<select id="matchType">
  <option value="ranked">Ranked</option>
  <option value="friendly">Friendly</option>
</select>

<label>Score</label>
<input id="score" placeholder="e.g. 3-2">

<button id="addMatchBtn">Save Match</button>

<div id="errorBox"></div>

<!-- üî• FINAL SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, updateDoc, increment, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBtXDuXLJyb10ZkHH8lpxT5",
  authDomain: "afnsclub.firebaseapp.com",
  projectId: "afnsclub"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* üîê AUTH + ADMIN CHECK (FINAL FIX) */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const adminRef = doc(db,"admins",user.uid);
  const adminSnap = await getDoc(adminRef);

  if(!adminSnap.exists() || adminSnap.data().active !== true){
    alert("‚ùå Admin access denied");
    await signOut(auth);
    location.href="login.html";
  }
});

/* üë§ ELEMENTS */
const p1Input=document.getElementById("player1");
const p2Input=document.getElementById("player2");
const p1List=document.getElementById("player1List");
const p2List=document.getElementById("player2List");
const resultSelect=document.getElementById("result");
const matchTypeSelect=document.getElementById("matchType");
const scoreInput=document.getElementById("score");
const addBtn=document.getElementById("addMatchBtn");
const errorBox=document.getElementById("errorBox");

/* üì¶ STATE */
let allPlayers=[];
let selectedP1=null;
let selectedP2=null;

/* üì• LOAD PLAYERS */
const snap = await getDocs(collection(db,"players"));
snap.forEach(d=>{
  allPlayers.push({id:d.id,...d.data()});
});

/* üîç SEARCH FUNCTION */
function render(input,list,isP1){
  list.innerHTML="";
  const q=input.value.trim().toLowerCase();
  if(!q)return;

  allPlayers
    .filter(p=>p.usernameLower && p.usernameLower.includes(q))
    .slice(0,6)
    .forEach(p=>{
      const div=document.createElement("div");
      div.textContent=p.username;
      div.className="search-item";
      div.onclick=()=>{
        input.value=p.username;
        list.innerHTML="";
        if(isP1) selectedP1=p;
        else selectedP2=p;
      };
      list.appendChild(div);
    });
}

p1Input.addEventListener("input",()=>render(p1Input,p1List,true));
p2Input.addEventListener("input",()=>render(p2Input,p2List,false));

/* ‚öîÔ∏è ADD MATCH */
addBtn.onclick = async ()=>{
  errorBox.textContent="";

  if(!selectedP1 || !selectedP2){
    errorBox.textContent="‚ùå Player 1 ‡¶è‡¶¨‡¶Ç Player 2 select ‡¶ï‡¶∞‡ßã";
    return;
  }

  if(selectedP1.id === selectedP2.id){
    errorBox.textContent="‚ùå Same player allowed ‡¶®‡¶æ";
    return;
  }

  try{
    const result=resultSelect.value;
    const score=scoreInput.value.trim();

    await addDoc(collection(db,"matches"),{
      player1Id:selectedP1.id,
      player1Name:selectedP1.username,
      player2Id:selectedP2.id,
      player2Name:selectedP2.username,
      result,
      score,
      matchType:matchTypeSelect.value,
      createdAt:new Date()
    });

    const p1Ref=doc(db,"players",selectedP1.id);
    const p2Ref=doc(db,"players",selectedP2.id);

    if(result==="Win"){
      await updateDoc(p1Ref,{wins:increment(1),matches:increment(1)});
      await updateDoc(p2Ref,{losses:increment(1),matches:increment(1)});
    }else if(result==="Lose"){
      await updateDoc(p1Ref,{losses:increment(1),matches:increment(1)});
      await updateDoc(p2Ref,{wins:increment(1),matches:increment(1)});
    }else{
      await updateDoc(p1Ref,{matches:increment(1)});
      await updateDoc(p2Ref,{matches:increment(1)});
    }

    p1Input.value="";
    p2Input.value="";
    scoreInput.value="";
    selectedP1=null;
    selectedP2=null;

    alert("‚úÖ Match Added Successfully");

  }catch(e){
    console.error(e);
    errorBox.textContent="‚ùå Firestore / Permission error";
  }
};
</script>

</body>
</html>
