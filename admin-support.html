<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Support Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --gold:#f5c46c;
  --blue:#4db6ff;
  --bg:#050b14;
}
body{margin:0;background:var(--bg);color:#fff;font-family:Segoe UI}
header{
  padding:14px;text-align:center;
  background:#020a12;font-weight:900
}
#role{color:var(--gold)}
.main{display:flex;height:calc(100vh - 60px)}
.users{
  width:30%;border-right:1px solid #123;
  overflow:auto
}
.users div{
  padding:12px;border-bottom:1px solid #123;
  cursor:pointer
}
.chat{flex:1;padding:14px;overflow:auto}
.msg{margin-bottom:8px}
footer{
  display:flex;gap:8px;padding:10px;
  background:#020a12
}
input{flex:1;padding:10px;border-radius:10px;border:none}
button{padding:10px 16px;border:none;border-radius:10px}
</style>
</head>

<body>
<header>
 Admin Support Console — <span id="role"></span>
</header>

<div class="main">
  <div class="users" id="users"></div>
  <div class="chat" id="chat"></div>
</div>

<footer>
  <input id="reply" placeholder="Reply...">
  <button onclick="send()">Send</button>
</footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});
const auth=firebase.auth(),db=firebase.firestore();

let ACTIVE_UID=null;
let ROLE=null, PERMS={};

auth.onAuthStateChanged(async u=>{
  if(!u){location.href="admin-login.html";return;}
  const d=await db.collection("admins").doc(u.uid).get();
  if(!d.exists){alert("Unauthorized");location.href="admin-login.html";return;}
  ROLE=d.data().role;
  PERMS=d.data().permissions||{};
  role.innerText=ROLE.toUpperCase();
  loadUsers();
});

function loadUsers(){
  db.collection("supportChats").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      const div=document.createElement("div");
      div.innerText=d.id;
      div.onclick=()=>openChat(d.id);
      users.appendChild(div);
    });
  });
}

function openChat(uid){
  ACTIVE_UID=uid;
  db.collection("supportChats").doc(uid)
    .collection("messages").orderBy("time")
    .onSnapshot(s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="msg";
        div.innerText=`${m.from}: ${m.text}`;
        chat.appendChild(div);
      });
      chat.scrollTop=chat.scrollHeight;
    });
}

function send(){
  if(!PERMS.reply){
    alert("❌ No permission to reply");
    return;
  }
  const t=reply.value.trim();
  if(!t||!ACTIVE_UID)return;
  reply.value="";
  db.collection("supportChats").doc(ACTIVE_UID)
    .collection("messages").add({
      from:"admin",
      text:`[${ROLE.toUpperCase()}] ${t}`,
      time:Date.now()
    });
}
</script>
</body>
</html>
