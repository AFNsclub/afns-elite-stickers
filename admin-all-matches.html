<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>All Matches | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;background:#050b1e;color:#fff;font-family:Segoe UI,sans-serif}
header{padding:14px;background:#0b1622;text-align:center;font-size:18px;color:#4f8cff}
.container{max-width:1100px;margin:auto;padding:16px}
select{padding:10px;border-radius:10px;border:none;margin-bottom:14px}
table{width:100%;border-collapse:collapse;background:#0b1622;border-radius:14px;overflow:hidden}
th,td{padding:10px;font-size:13px}
th{background:#081020;color:#4f8cff}
tr:nth-child(even){background:rgba(255,255,255,.03)}
.badge{padding:4px 8px;border-radius:8px;font-size:11px;font-weight:700}
.win{background:#1f8f5f}
.loss{background:#8f1f1f}
button{background:#ff4f4f;border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
button[disabled]{background:#333;cursor:not-allowed}
.empty{text-align:center;opacity:.6;padding:20px}
</style>
</head>

<body>

<header>ðŸ§¾ All Player Match History (Admin)</header>

<div class="container">

<select id="seasonFilter" onchange="loadMatches()">
  <option value="all">All Seasons</option>
</select>

<table>
<thead>
<tr>
  <th>Time</th>
  <th>Player</th>
  <th>Opponent</th>
  <th>Result</th>
  <th>Score</th>
  <th>Season</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div id="empty" class="empty" style="display:none">No matches found</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth=firebase.auth();
const db=firebase.firestore();

let CAN_ROLLBACK=false;

/* ðŸ” AUTH + PERMISSION */
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }

  const admin=await db.collection("admins").doc(user.uid).get();
  if(!admin.exists){
    alert("Unauthorized");
    location.href="admin.html";
    return;
  }

  CAN_ROLLBACK = admin.data().permissions?.editMatch === true;

  loadSeasons();
  loadMatches();
});

/* LOAD SEASONS */
async function loadSeasons(){
  const snap=await db.collection("seasons").orderBy("start","desc").get();
  snap.forEach(d=>{
    seasonFilter.innerHTML+=
      `<option value="${d.id}">${d.data().name||d.id}</option>`;
  });
}

/* LOAD MATCHES */
async function loadMatches(){
  list.innerHTML="";
  empty.style.display="none";

  let q=db.collection("matches").orderBy("time","desc");
  if(seasonFilter.value!=="all"){
    q=q.where("seasonId","==",seasonFilter.value);
  }

  const snap=await q.get();
  if(snap.empty){
    empty.style.display="block";
    return;
  }

  snap.forEach(doc=>{
    const m=doc.data();
    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td>${m.time?.toDate().toLocaleString()||"-"}</td>
      <td>${m.playerId}</td>
      <td>${m.opponent||"-"}</td>
      <td><span class="badge ${m.result}">${m.result.toUpperCase()}</span></td>
      <td>${m.score||"-"}</td>
      <td>${m.seasonId||"-"}</td>
      <td>
        ${CAN_ROLLBACK
          ? `<button onclick="rollback('${doc.id}')">Rollback</button>`
          : "-"
        }
      </td>
    `;
    list.appendChild(tr);
  });
}

/* ðŸ”¥ ROLLBACK */
async function rollback(id){
  if(!CAN_ROLLBACK){
    alert("Permission denied");
    return;
  }

  if(!confirm("Rollback this match?")) return;

  const ref=db.collection("matches").doc(id);
  const snap=await ref.get();
  if(!snap.exists) return alert("Match missing");

  await db.runTransaction(async(t)=>{
    t.update(db.collection("players").doc(snap.data().playerId), snap.data().before);
    t.delete(ref);
  });

  alert("âœ… Match rolled back");
  loadMatches();
}
</script>

</body>
</html>
