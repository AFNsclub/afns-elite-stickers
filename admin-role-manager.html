<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Role Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#050b1e;
  color:#fff;
  font-family:Segoe UI,Arial,sans-serif;
  padding:20px;
}
.box{
  max-width:520px;
  margin:auto;
  background:#0b1622;
  padding:20px;
  border-radius:16px;
  border:1px solid #00eaff55;
}
.logo{
  display:block;
  margin:0 auto 10px;
  width:80px;
}
h2{
  text-align:center;
  color:#ffd24d;
}
select,input{
  width:100%;
  margin:8px 0;
  padding:12px;
  border-radius:12px;
  border:none;
}
button{
  width:100%;
  padding:14px;
  background:#00eaff;
  border:none;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
}
.permissions label{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  font-size:14px;
}
small{
  display:block;
  text-align:center;
  opacity:.6;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="box">
  <img src="logo.png" class="logo">
  <h2>üõ°Ô∏è Role Manager</h2>

  <!-- PLAYER -->
  <select id="playerSelect">
    <option value="">Loading players...</option>
  </select>

  <!-- ROLE -->
  <select id="role">
    <option value="admin">Admin</option>
    <option value="captain">Captain</option>
    <option value="vice-captain">Vice Captain</option>
    <option value="manager">Manager</option>
  </select>

  <input id="team" placeholder="Team / Responsibility">
  <input id="badge" placeholder="Emoji Badge (üëë ‚≠ê ‚öîÔ∏è)">

  <!-- PERMISSIONS -->
  <div class="permissions">
    <label>Add Match <input type="checkbox" id="addMatch"></label>
    <label>Edit Match <input type="checkbox" id="editMatch"></label>
    <label>Delete Match <input type="checkbox" id="deleteMatch"></label>
    <label>Approve Match <input type="checkbox" id="approveMatch"></label>
    <label>Manage Roles <input type="checkbox" id="manageRoles"></label>
    <label>Season Reset <input type="checkbox" id="seasonReset"></label>
  </div>

  <!-- SAVE -->
  <button type="button" onclick="saveRole()">Save Role</button>
  <small>Only OWNER can manage roles</small>
</div>

<script>
/* üî• FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain: "afnsclub.firebaseapp.com",
  projectId: "afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* üîê AUTH CHECK */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }
  loadPlayers();
});

/* üë§ LOAD PLAYERS (NO RULE CONFLICT) */
function loadPlayers(){
  const select = document.getElementById("playerSelect");

  db.collection("players").onSnapshot(snap=>{
    const players = [];

    snap.forEach(doc=>{
      const p = doc.data();
      players.push({
        id: doc.id,
        name: p.username || p.usernameLower || "Unknown"
      });
    });

    players.sort((a,b)=>
      a.name.toLowerCase().localeCompare(b.name.toLowerCase())
    );

    select.innerHTML = '<option value="">Select Player</option>';
    players.forEach(p=>{
      select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
  });
}

/* üîÑ LOAD ADMIN DATA */
document.getElementById("playerSelect").addEventListener("change", loadAdminData);

async function loadAdminData(){
  const uid = playerSelect.value;
  if(!uid) return;

  const snap = await db.collection("admins").doc(uid).get();
  if(!snap.exists) return;

  const a = snap.data();
  role.value = a.role || "admin";
  team.value = a.team || "";
  badge.value = a.badge || "";

  addMatch.checked     = !!a.permissions?.addMatch;
  editMatch.checked    = !!a.permissions?.editMatch;
  deleteMatch.checked  = !!a.permissions?.deleteMatch;
  approveMatch.checked = !!a.permissions?.approveMatch;
  manageRoles.checked  = !!a.permissions?.manageRoles;
  seasonReset.checked  = !!a.permissions?.seasonReset;
}

/* üíæ SAVE ROLE ‚Äî FINAL & WORKING */
async function saveRole(){
  const uid = playerSelect.value;
  if(!uid){
    alert("Select a player first");
    return;
  }

  try{
    await db.collection("admins").doc(uid).set({
      active: true,
      role: role.value,
      team: team.value,
      badge: badge.value,
      permissions:{
        addMatch: addMatch.checked,
        editMatch: editMatch.checked,
        deleteMatch: deleteMatch.checked,
        approveMatch: approveMatch.checked,
        manageRoles: manageRoles.checked,
        seasonReset: seasonReset.checked
      },
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    alert("‚úÖ Role saved successfully");
  }catch(err){
    alert("‚ùå Save failed: " + err.message);
    console.error(err);
  }
}
</script>

</body>
</html>
