<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Role Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#050b1e;
  color:#fff;
  font-family:Segoe UI,Arial,sans-serif;
  padding:20px;
}
.box{
  max-width:520px;
  margin:auto;
  background:#0b1622;
  padding:20px;
  border-radius:16px;
  border:1px solid #00eaff55;
}
.logo{
  display:block;
  margin:0 auto 10px;
  width:70px;
}
h2{
  text-align:center;
  color:#ffd24d;
}
select,input{
  width:100%;
  margin:8px 0;
  padding:12px;
  border-radius:12px;
  border:none;
}
button{
  width:100%;
  padding:14px;
  background:#00eaff;
  border:none;
  border-radius:14px;
  font-weight:800;
}
.permissions label{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  font-size:14px;
}
small{
  display:block;
  text-align:center;
  opacity:.6;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="box">
  <img src="logo.png" class="logo">
  <h2>üõ°Ô∏è Role Manager</h2>

  <select id="playerSelect" onchange="loadAdminData()">
    <option>Loading players...</option>
  </select>

  <select id="role">
    <option value="admin">Admin</option>
    <option value="captain">Captain</option>
    <option value="vice-captain">Vice Captain</option>
    <option value="manager">Manager</option>
  </select>

  <input id="team" placeholder="Team / Responsibility">
  <input id="badge" placeholder="Emoji Badge (üëë ‚≠ê ‚öîÔ∏è)">

  <div class="permissions">
    <label>Add Match <input type="checkbox" id="addMatch"></label>
    <label>Edit Match <input type="checkbox" id="editMatch"></label>
    <label>Delete Match <input type="checkbox" id="deleteMatch"></label>
    <label>Approve Match <input type="checkbox" id="approveMatch"></label>
    <label>Manage Roles <input type="checkbox" id="manageRoles"></label>
    <label>Season Reset <input type="checkbox" id="seasonReset"></label>
  </div>

  <button onclick="saveRole()">Save Role</button>
  <small>Only OWNER can manage roles</small>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ‚úÖ AUTH ONLY ‚Äî RULES WILL HANDLE OWNER */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }
  loadPlayers(); // üî• always load
});

/* ‚úÖ PLAYERS LOAD (100% FIXED) */
function loadPlayers(){
  const select = playerSelect;
  db.collection("players").onSnapshot(snap=>{
    const arr = [];
    snap.forEach(d=>{
      const p=d.data();
      arr.push({
        id:d.id,
        name:p.username || p.usernameLower || "Unknown"
      });
    });

    arr.sort((a,b)=>a.name.localeCompare(b.name));
    select.innerHTML='<option value="">Select Player</option>';
    arr.forEach(p=>{
      select.innerHTML+=`<option value="${p.id}">${p.name}</option>`;
    });
  });
}

/* LOAD ADMIN DATA */
async function loadAdminData(){
  const id = playerSelect.value;
  if(!id) return;
  const snap = await db.collection("admins").doc(id).get().catch(()=>null);
  if(!snap || !snap.exists) return;

  const a=snap.data();
  role.value=a.role||"admin";
  team.value=a.team||"";
  badge.value=a.badge||"";
  Object.keys(a.permissions||{}).forEach(k=>{
    document.getElementById(k).checked=!!a.permissions[k];
  });
}

/* SAVE ROLE ‚Äî RULES WILL VERIFY OWNER */
async function saveRole(){
  const id=playerSelect.value;
  if(!id) return alert("Select player");

  await db.collection("admins").doc(id).set({
    active:true,
    role:role.value,
    team:team.value,
    badge:badge.value,
    permissions:{
      addMatch:addMatch.checked,
      editMatch:editMatch.checked,
      deleteMatch:deleteMatch.checked,
      approveMatch:approveMatch.checked,
      manageRoles:manageRoles.checked,
      seasonReset:seasonReset.checked
    }
  },{merge:true});

  alert("Role saved ‚úÖ");
}
</script>
</body>
  </html>
