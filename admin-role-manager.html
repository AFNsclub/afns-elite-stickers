<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Role Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#050b1e;
  color:#fff;
  font-family:Segoe UI,Arial,sans-serif;
  padding:20px;
}
.box{
  max-width:520px;
  margin:auto;
  background:#0b1622;
  padding:20px;
  border-radius:16px;
  border:1px solid #00eaff55;
}
h2{
  text-align:center;
  color:#ffd24d;
}
select,input{
  width:100%;
  margin:8px 0;
  padding:10px;
  border-radius:10px;
  border:none;
}
button{
  width:100%;
  padding:12px;
  background:#00eaff;
  border:none;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
}
.permissions label{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  font-size:14px;
}
small{
  display:block;
  text-align:center;
  opacity:.6;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="box">
  <h2>üõ°Ô∏è Role Manager</h2>

  <!-- PLAYER SELECT -->
  <select id="playerSelect" onchange="loadAdminData()">
    <option value="">Loading players...</option>
  </select>

  <!-- ROLE -->
  <select id="role">
    <option value="admin">Admin</option>
    <option value="captain">Captain</option>
    <option value="vice-captain">Vice Captain</option>
    <option value="manager">Manager</option>
  </select>

  <input id="team" placeholder="Team / Responsibility">
  <input id="badge" placeholder="Emoji Badge (üëë ‚≠ê ‚öîÔ∏è)">

  <!-- PERMISSIONS -->
  <div class="permissions">
    <label>Add Match <input type="checkbox" id="addMatch"></label>
    <label>Edit Match <input type="checkbox" id="editMatch"></label>
    <label>Delete Match <input type="checkbox" id="deleteMatch"></label>
    <label>Approve Match <input type="checkbox" id="approveMatch"></label>
    <label>Manage Roles <input type="checkbox" id="manageRoles"></label>
    <label>Season Reset <input type="checkbox" id="seasonReset"></label>
  </div>

  <button onclick="saveRole()">Save Role</button>
  <small>Only OWNER can manage roles</small>
</div>

<script>
/* üî• FIREBASE INIT */
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db   = firebase.firestore();

/* üîê OWNER ONLY */
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }

  const snap = await db.collection("admins").doc(user.uid).get();
  if(!snap.exists || snap.data().role !== "owner"){
    alert("Access denied");
    location.href="admin.html";
    return;
  }

  loadPlayers();
});

/* ‚úÖ LOAD PLAYERS ‚Äî FINAL & SAFE (NO orderBy BUG) */
async function loadPlayers(){
  try{
    const snap = await db.collection("players").get();
    const select = document.getElementById("playerSelect");

    const players = [];

    snap.forEach(d=>{
      const p = d.data();
      players.push({
        id: d.id,
        name: p.username || p.usernameLower || "Unknown"
      });
    });

    // client-side sort (safe)
    players.sort((a,b)=>
      a.name.toLowerCase().localeCompare(b.name.toLowerCase())
    );

    select.innerHTML = `<option value="">Select Player</option>`;
    players.forEach(p=>{
      select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });

  }catch(err){
    console.error("LOAD PLAYERS ERROR:", err);
    alert("Failed to load players");
  }
}

/* üîÑ LOAD EXISTING ADMIN DATA */
async function loadAdminData(){
  const uid = playerSelect.value;
  if(!uid) return;

  const snap = await db.collection("admins").doc(uid).get();

  if(!snap.exists){
    role.value = "admin";
    team.value = "";
    badge.value = "";
    document.querySelectorAll(".permissions input")
      .forEach(c=>c.checked=false);
    return;
  }

  const a = snap.data();
  role.value = a.role || "admin";
  team.value = a.team || "";
  badge.value = a.badge || "";

  addMatch.checked     = !!a.permissions?.addMatch;
  editMatch.checked    = !!a.permissions?.editMatch;
  deleteMatch.checked  = !!a.permissions?.deleteMatch;
  approveMatch.checked = !!a.permissions?.approveMatch;
  manageRoles.checked  = !!a.permissions?.manageRoles;
  seasonReset.checked  = !!a.permissions?.seasonReset;
}

/* üíæ SAVE ROLE */
async function saveRole(){
  const uid = playerSelect.value;
  if(!uid){
    alert("Select a player");
    return;
  }

  const playerSnap = await db.collection("players").doc(uid).get();

  await db.collection("admins").doc(uid).set({
    active: true,
    role: role.value,
    team: team.value,
    badge: badge.value,
    email: playerSnap.data()?.email || "",
    permissions:{
      addMatch: addMatch.checked,
      editMatch: editMatch.checked,
      deleteMatch: deleteMatch.checked,
      approveMatch: approveMatch.checked,
      manageRoles: manageRoles.checked,
      seasonReset: seasonReset.checked
    }
  }, { merge:true });

  alert("Role updated successfully ‚úÖ");
}
</script>

</body>
</html>
