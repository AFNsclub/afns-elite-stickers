<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Approve Matches | AFNs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  background:#050b1e;
  color:#fff;
  font-family:Segoe UI,Arial;
}
.box{
  max-width:520px;
  margin:25px auto;
  background:#0b1622;
  padding:20px;
  border-radius:18px;
  box-shadow:0 0 25px #00eaff33;
}
h2{
  text-align:center;
  color:#ffd24d;
}
.card{
  background:#020814;
  border:1px solid #1f2d44;
  border-radius:14px;
  padding:14px;
  margin-top:12px;
}
.row{
  font-size:14px;
  margin-bottom:6px;
}
.actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}
button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.approve{background:#00eaff;color:#00131f;}
.reject{background:#ff4d4d;color:#fff;}
.small{
  text-align:center;
  opacity:.6;
  margin-top:15px;
}
</style>
</head>

<body>

<div class="box">
  <h2>üõ°Ô∏è Pending Match Approvals</h2>
  <div id="list"></div>
  <div id="msg" class="small"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();
const list = document.getElementById("list");
const msg  = document.getElementById("msg");

auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  // üîê Admin check (EMAIL based)
  const adminDoc = await db
    .collection("admins")
    .doc(user.email)
    .get();

  if(
    !adminDoc.exists ||
    adminDoc.data().active !== true ||
    adminDoc.data().permissions?.approveMatch !== true
  ){
    alert("Admin access denied");
    location.href="index.html";
    return;
  }

  loadPending();
});

async function loadPending(){
  list.innerHTML = "";
  msg.innerText = "Loading pending matches...";

  const snap = await db
    .collection("matches_pending")
    .where("status","==","pending")
    .orderBy("createdAt","desc")
    .get();

  if(snap.empty){
    msg.innerText = "No pending matches üéâ";
    return;
  }

  msg.innerText = "";

  for(const doc of snap.docs){
    const d = doc.data();

    const player = await getUsername(d.playerId);
    const opponent = await getUsername(d.opponentId);

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row"><b>Player:</b> ${player}</div>
      <div class="row"><b>Opponent:</b> ${opponent}</div>
      <div class="row"><b>Type:</b> ${d.matchType}</div>
      ${d.tournamentName ? `<div class="row"><b>Tournament:</b> ${d.tournamentName}</div>` : ""}
      <div class="row"><b>Score:</b> ${d.score}</div>

      <div class="actions">
        <button class="approve" onclick="approveMatch('${doc.id}')">Approve</button>
        <button class="reject" onclick="rejectMatch('${doc.id}')">Reject</button>
      </div>
    `;
    list.appendChild(div);
  }
}

async function getUsername(uid){
  const p = await db.collection("players").doc(uid).get();
  return p.exists ? p.data().username : "Unknown";
}

async function approveMatch(id){
  if(!confirm("Approve this match?")) return;

  const ref = db.collection("matches_pending").doc(id);
  const data = (await ref.get()).data();

  await db.collection("matches").add({
    ...data,
    status:"approved",
    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await ref.delete();
  loadPending();
}

async function rejectMatch(id){
  if(!confirm("Reject this match?")) return;
  await db.collection("matches_pending").doc(id).delete();
  loadPending();
}
</script>

</body>
</html>
