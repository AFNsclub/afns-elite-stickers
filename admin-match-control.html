<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Match Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;background:#050b1e;color:#fff;font-family:Arial}
.container{max-width:900px;margin:20px auto;padding:16px}
.card{background:#0b1622;border-radius:14px;padding:14px;margin-bottom:12px}
button{padding:8px 12px;border:none;border-radius:10px;font-weight:700;cursor:pointer;margin:4px}
.approve{background:#00ff99}
.reject{background:#ff9900}
.rollback{background:#ff4444;color:#fff}
.edit{background:#00eaff}
.recalc{background:#00c853;margin-bottom:15px}
</style>
</head>
<body>
<div class="container">
  <h2>ðŸ›  Match Control Panel</h2>
  <button class="recalc" onclick="recalculateAllRatings()">ðŸ”¥ Recalculate All Ratings</button>
  <div id="list"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ===== AUTH CHECK ===== */
auth.onAuthStateChanged(async user => {
  if(!user){ location.href="admin-login.html"; return; }
  const snap = await db.collection("admins").doc(user.email).get();
  if(!snap.exists || snap.data().active!==true){
    alert("Access denied");
    location.href="admin-login.html";
    return;
  }
});

/* ===== APPROVE MATCH ===== */
async function approveMatch(id){
  const ref=db.collection("matches").doc(id);
  const snap=await ref.get();
  if(!snap.exists) return;

  const m=snap.data();
  if(m.status==="approved"){ alert("Already approved"); return; }

  if(!m.score || !m.score.includes("-")){ alert("Invalid score"); return; }
  const [s1,s2]=m.score.split("-").map(Number);
  if(isNaN(s1)||isNaN(s2)){ alert("Invalid score"); return; }

  const p1Snap=await db.collection("players").where("username","==",m.player1).get();
  const p2Snap=await db.collection("players").where("username","==",m.player2).get();
  if(p1Snap.empty||p2Snap.empty){ alert("Player not found"); return; }

  const p1Doc=p1Snap.docs[0];
  const p2Doc=p2Snap.docs[0];

  let p1={wins:0,losses:0,draws:0,...p1Doc.data()};
  let p2={wins:0,losses:0,draws:0,...p2Doc.data()};

  let r1=p1.rating||1000;
  let r2=p2.rating||1000;

  const K=m.matchType==="tournament"?48:32;

  const expected1=1/(1+Math.pow(10,(r2-r1)/400));
  const expected2=1/(1+Math.pow(10,(r1-r2)/400));

  let a1=0,a2=0;
  if(s1===s2){a1=a2=0.5;}
  else if(s1>s2){a1=1;a2=0;}
  else{a1=0;a2=1;}

  const newR1=Math.round(r1+K*(a1-expected1));
  const newR2=Math.round(r2+K*(a2-expected2));

  if(s1===s2){p1.draws++;p2.draws++;}
  else if(s1>s2){p1.wins++;p2.losses++;}
  else{p2.wins++;p1.losses++;}

  await p1Doc.ref.update({rating:newR1,wins:p1.wins,losses:p1.losses,draws:p1.draws});
  await p2Doc.ref.update({rating:newR2,wins:p2.wins,losses:p2.losses,draws:p2.draws});

  await ref.update({
    status:"approved",
    ratingBefore1:r1,
    ratingBefore2:r2,
    ratingAfter1:newR1,
    ratingAfter2:newR2,
    approvedAt:firebase.firestore.FieldValue.serverTimestamp()
  });
}

/* ===== REJECT MATCH ===== */
async function rejectMatch(id){
  if(!confirm("Reject this match?")) return;
  await db.collection("matches").doc(id).update({
    status:"rejected",
    rejectedAt:firebase.firestore.FieldValue.serverTimestamp()
  });
}

/* ===== ROLLBACK MATCH ===== */
async function rollbackMatch(id){
  if(!confirm("Rollback this match?")) return;

  const ref=db.collection("matches").doc(id);
  const snap=await ref.get();
  if(!snap.exists) return;

  const m=snap.data();
  if(m.status!=="approved"){ alert("Not approved match"); return; }

  const p1Snap=await db.collection("players").where("username","==",m.player1).get();
  const p2Snap=await db.collection("players").where("username","==",m.player2).get();
  if(p1Snap.empty||p2Snap.empty) return;

  const p1Doc=p1Snap.docs[0];
  const p2Doc=p2Snap.docs[0];

  let p1=p1Doc.data();
  let p2=p2Doc.data();

  const [s1,s2]=m.score.split("-").map(Number);

  if(s1===s2){p1.draws--;p2.draws--;}
  else if(s1>s2){p1.wins--;p2.losses--;}
  else{p2.wins--;p1.losses--;}

  await p1Doc.ref.update({
    rating:m.ratingBefore1,
    wins:Math.max(0,p1.wins),
    losses:Math.max(0,p1.losses),
    draws:Math.max(0,p1.draws)
  });

  await p2Doc.ref.update({
    rating:m.ratingBefore2,
    wins:Math.max(0,p2.wins),
    losses:Math.max(0,p2.losses),
    draws:Math.max(0,p2.draws)
  });

  await ref.update({status:"rolledback"});
}

/* ===== FULL RECALCULATE ===== */
async function recalculateAllRatings(){
  if(!confirm("Recalculate ALL ratings from zero?")) return;

  alert("Processing...");

  const players=await db.collection("players").get();
  for(const p of players.docs){
    await p.ref.update({rating:1000,wins:0,losses:0,draws:0});
  }

  const matches=await db.collection("matches")
    .where("status","==","approved")
    .orderBy("createdAt","asc")
    .get();

  for(const mDoc of matches.docs){
    await mDoc.ref.update({status:"pending"});
    await approveMatch(mDoc.id);
  }

  alert("All Ratings Recalculated ðŸ”¥");
}

/* ===== LOAD MATCHES LIVE ===== */
db.collection("matches").orderBy("createdAt","desc").onSnapshot(snapshot=>{
  const list=document.getElementById("list");
  list.innerHTML="";
  if(snapshot.empty){ list.innerHTML="No matches"; return; }

  snapshot.forEach(doc=>{
    const m=doc.data();
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<b>${m.player1}</b> vs <b>${m.player2}</b><br>
                    Score: ${m.score||"â€”"}<br>
                    Type: ${m.matchType||"friendly"}<br>
                    Status: ${m.status||"pending"}<br><br>
                    ${m.status==="pending"? `<button class="approve" onclick="approveMatch('${doc.id}')">Approve</button>
                                             <button class="reject" onclick="rejectMatch('${doc.id}')">Reject</button>`:""}
                    ${m.status==="approved"? `<button class="rollback" onclick="rollbackMatch('${doc.id}')">Rollback</button>`:""}
                    <button class="edit" onclick="editMatch('${doc.id}')">Edit Score</button>`;
    list.appendChild(card);
  });
});

/* ===== EDIT SCORE ===== */
async function editMatch(id){
  const score=prompt("Enter new score (Example: 2-1)");
  if(!score||!score.includes("-")) return;
  await db.collection("matches").doc(id).update({score});
  alert("Score updated.");
}
</script>
</body>
</html>
