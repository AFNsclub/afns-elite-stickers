<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Match Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  background:#050b1e;
  color:#fff;
  font-family:Arial,sans-serif;
}
.container{
  max-width:900px;
  margin:20px auto;
  padding:16px;
}
.card{
  background:#0b1622;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.edit{ background:#00eaff }
.rollback{ background:#ff4d4d; color:#fff }
.approve{ background:#00ff99 }
</style>
</head>

<body>

<div class="container">
  <h2>ðŸ›  Match Control</h2>
  <div id="list"></div>
</div>

<script>

firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }

  const snap = await db.collection("admins").doc(user.email).get();

  if(!snap.exists || snap.data().active !== true){
    alert("Access denied");
    location.href="admin-login.html";
    return;
  }

  loadMatches();
});

async function loadMatches(){

  const list = document.getElementById("list");
  list.innerHTML="";

  const snap = await db.collection("matches")
    .orderBy("createdAt","desc")
    .get();

  if(snap.empty){
    list.innerHTML="<p>No matches</p>";
    return;
  }

  snap.forEach(d=>{
    const m = d.data();

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <b>${m.playerName}</b> vs <b>${m.opponentName}</b><br>
      Score: ${m.score}<br>
      Status: ${m.status || "pending"}<br><br>

      ${m.status==="pending"
        ? `<button class="approve" onclick="approveMatch('${d.id}')">Approve</button>`
        : ""}

      <button class="edit" onclick="editMatch('${d.id}')">Edit</button>
      <button class="rollback" onclick="rollbackMatch('${d.id}')">Rollback</button>
    `;

    list.appendChild(card);
  });
}

async function approveMatch(id){
  await db.collection("matches").doc(id).update({
    status:"approved",
    approvedAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  loadMatches();
}

async function editMatch(id){
  const score=prompt("New score");
  if(!score) return;
  await db.collection("matches").doc(id).update({ score });
  loadMatches();
}

async function rollbackMatch(id){
  if(!confirm("Rollback match?")) return;
  await db.collection("matches").doc(id).update({ rolledBack:true });
  loadMatches();
}

</script>
</body>
</html>
