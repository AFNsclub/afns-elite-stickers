<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Match Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  background:#050b1e;
  color:#fff;
  font-family:Segoe UI,Arial,sans-serif;
}
.container{
  max-width:900px;
  margin:20px auto;
  padding:16px;
}
h2{
  text-align:center;
  color:#ffd24d;
  margin-bottom:20px;
}
.card{
  background:#0b1622;
  border:1px solid #00eaff55;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}
.info{
  font-size:14px;
  line-height:1.6;
}
.actions{
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.edit{ background:#00eaff; color:#00222c }
.rollback{ background:#ff4d4d; color:#330000 }
</style>
</head>

<body>

<div class="container">
  <h2>üõ† Match Control</h2>
  <div id="list"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db   = firebase.firestore();

/* üîê ADMIN CHECK */
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const adminSnap = await db.collection("admins").doc(user.uid).get();
if(!adminSnap.exists){
  alert("Access denied");
  location.href="admin-login.html";
  return;
}

const admin = adminSnap.data();

// example: permission check
if(!admin.permissions?.editMatch){
  alert("No permission");
  return;
}

  loadMatches();
});

/* üì• LOAD MATCHES */
async function loadMatches(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  const snap = await db.collection("matches")
    .orderBy("approvedAt","desc")
    .get();

  if(snap.empty){
    list.innerHTML = "<p>No matches found</p>";
    return;
  }

  for(const doc of snap.docs){
    const m = doc.data();

    const p1 = await db.collection("players").doc(m.playerId).get();
    const p2 = await db.collection("players").doc(m.opponentId).get();

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="info">
        <b>${p1.data().username}</b> vs <b>${p2.data().username}</b><br>
        Score: ${m.score}<br>
        Type: ${m.matchType}
        ${m.tournamentName ? `<br>Tournament: ${m.tournamentName}` : ""}
        ${m.edited ? "<br>‚úè Edited" : ""}
        ${m.rolledBack ? "<br>‚ôª Rolled Back" : ""}
      </div>

      <div class="actions">
        <button class="edit" onclick="editMatch('${doc.id}')">‚úè Edit Score</button>
        <button class="rollback" onclick="rollbackMatch('${doc.id}')">‚ôª Rollback</button>
      </div>
    `;
    list.appendChild(card);
  }
}

/* ‚úè EDIT */
async function editMatch(id){
  const newScore = prompt("Enter new score (ex: 2-1)");
  if(!newScore) return;

  await db.collection("matches").doc(id).update({
    score: newScore,
    edited: true
  });

  log("Match edited: "+id);
  loadMatches();
}

/* ‚ôª ROLLBACK */
async function rollbackMatch(id){
  if(!confirm("Rollback this match?")) return;

  await db.collection("matches").doc(id).update({
    rolledBack: true
  });

  log("Match rollback: "+id);
  loadMatches();
}

/* üìù ACTIVITY LOG */
function log(text){
  db.collection("activity").add({
    text,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
}
</script>

</body>
</html>
