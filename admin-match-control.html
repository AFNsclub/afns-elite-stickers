<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Match Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  background:#050b1e;
  color:#fff;
  font-family:Arial,sans-serif;
}
.container{
  max-width:900px;
  margin:20px auto;
  padding:16px;
}
.card{
  background:#0b1622;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.edit{ background:#00eaff }
.rollback{ background:#ff4d4d; color:#fff }
.approve{ background:#00ff99 }
</style>
</head>

<body>

<div class="container">
  <h2>ðŸ›  Match Control</h2>
  <div id="list"></div>
</div>

<script>

firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= AUTH CHECK ================= */

auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }

  const snap = await db.collection("admins").doc(user.email).get();

  if(!snap.exists || snap.data().active !== true){
    alert("Access denied");
    location.href="admin-login.html";
    return;
  }

  loadMatches();
});

/* ================= LOAD MATCHES ================= */

async function loadMatches(){

  const list = document.getElementById("list");
  list.innerHTML="";

  const snap = await db.collection("matches")
    .orderBy("createdAt","desc")
    .get();

  if(snap.empty){
    list.innerHTML="<p>No matches</p>";
    return;
  }

  snap.forEach(d=>{
    const m = d.data();

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <b>${m.player1 || m.playerName}</b> vs <b>${m.player2 || m.opponentName}</b><br>
      Score: ${m.score}<br>
      Type: ${m.matchType || "friendly"}<br>
      Status: ${m.status || "pending"}<br><br>

      ${m.status==="pending"
        ? `<button class="approve" onclick="approveMatch('${d.id}')">Approve</button>`
        : ""}

      <button class="edit" onclick="editMatch('${d.id}')">Edit</button>
      <button class="rollback" onclick="rollbackMatch('${d.id}')">Rollback</button>
    `;

    list.appendChild(card);
  });
}

async function approveMatch(id){

  const matchRef = db.collection("matches").doc(id);
  const matchSnap = await matchRef.get();
  if(!matchSnap.exists) return;

  const match = matchSnap.data();
  if(match.status !== "pending"){
    alert("Already processed");
    return;
  }

  const p1Name = match.player1;
  const p2Name = match.player2;

  const p1Snap = await db.collection("players")
    .where("username","==",p1Name).get();
  const p2Snap = await db.collection("players")
    .where("username","==",p2Name).get();

  if(p1Snap.empty || p2Snap.empty){
    alert("Player not found");
    return;
  }

  const p1Doc = p1Snap.docs[0];
  const p2Doc = p2Snap.docs[0];

  const p1 = p1Doc.data();
  const p2 = p2Doc.data();

  let rating1 = p1.rating || 1000;
  let rating2 = p2.rating || 1000;

  const K = match.matchType==="tournament" ? 48 : 32;

  const expected1 = 1/(1+Math.pow(10,(rating2-rating1)/400));
  const expected2 = 1/(1+Math.pow(10,(rating1-rating2)/400));

  const [s1,s2] = match.score.split("-").map(Number);

  let actual1=0, actual2=0;

  if(s1===s2){
    actual1=0.5; actual2=0.5;
  } else if(s1>s2){
    actual1=1; actual2=0;
  } else {
    actual1=0; actual2=1;
  }

  const newR1 = Math.round(rating1 + K*(actual1-expected1));
  const newR2 = Math.round(rating2 + K*(actual2-expected2));

  await p1Doc.ref.update({
    rating:newR1,
    wins: actual1===1 ? (p1.wins||0)+1 : (p1.wins||0),
    losses: actual1===0 && s1!==s2 ? (p1.losses||0)+1 : (p1.losses||0),
    draws: s1===s2 ? (p1.draws||0)+1 : (p1.draws||0)
  });

  await p2Doc.ref.update({
    rating:newR2,
    wins: actual2===1 ? (p2.wins||0)+1 : (p2.wins||0),
    losses: actual2===0 && s1!==s2 ? (p2.losses||0)+1 : (p2.losses||0),
    draws: s1===s2 ? (p2.draws||0)+1 : (p2.draws||0)
  });

  await matchRef.update({
    status:"approved",
    resultProcessed:true,
    approvedAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Match Approved + Rating Updated");
  loadMatches();
}

/* ================= EDIT ================= */

async function editMatch(id){
  const score=prompt("New score");
  if(!score) return;
  await db.collection("matches").doc(id).update({ score });
  loadMatches();
}

/* ================= ROLLBACK ================= */

async function rollbackMatch(id){
  if(!confirm("Rollback match?")) return;
  await db.collection("matches").doc(id).update({ rolledBack:true });
  loadMatches();
}

</script>
</body>
</html>
