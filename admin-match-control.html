<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Match Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#0f172a;color:#fff;font-family:Arial}
.container{max-width:800px;margin:auto;padding:20px}
.card{background:#1e293b;padding:15px;border-radius:12px;margin-bottom:10px}
button{padding:6px 10px;border:none;border-radius:6px;font-weight:bold}
.approve{background:#22c55e}
</style>
</head>
<body>
<div class="container">
<h2>Admin Match Control</h2>
<div id="list"></div>
</div>

<script>
firebase.initializeApp({
apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
authDomain:"afnsclub.firebaseapp.com",
projectId:"afnsclub"
});

const auth=firebase.auth();
const db=firebase.firestore();

auth.onAuthStateChanged(user=>{
if(!user){location="admin-login.html";return;}
loadMatches();
});

async function loadMatches(){
const list=document.getElementById("list");
list.innerHTML="";
const snap=await db.collection("matches").orderBy("createdAt","desc").get();

snap.forEach(doc=>{
const m=doc.data();
list.innerHTML+=`
<div class="card">
<b>${m.player1}</b> vs <b>${m.player2}</b><br>
Score: ${m.score}<br>
Status: ${m.status||"pending"}<br>
${m.status==="pending"?`<button class="approve" onclick="approveMatch('${doc.id}')">Approve</button>`:""}
</div>`;
});
}

async function approveMatch(id){
const matchRef=db.collection("matches").doc(id);
const matchSnap=await matchRef.get();
const match=matchSnap.data();
if(match.status!=="pending") return;

const p1Snap=await db.collection("players").where("username","==",match.player1).get();
const p2Snap=await db.collection("players").where("username","==",match.player2).get();
if(p1Snap.empty||p2Snap.empty)return;

const p1=p1Snap.docs[0];
const p2=p2Snap.docs[0];

const [s1,s2]=match.score.split("-").map(Number);

let a1=0,a2=0;
if(s1===s2){a1=.5;a2=.5;}
else if(s1>s2){a1=1;a2=0;}
else{a1=0;a2=1;}

const r1=p1.data().rating||1000;
const r2=p2.data().rating||1000;
const K=32;

const e1=1/(1+Math.pow(10,(r2-r1)/400));
const e2=1/(1+Math.pow(10,(r1-r2)/400));

await p1.ref.update({
rating:Math.round(r1+K*(a1-e1)),
wins:a1===1?(p1.data().wins||0)+1:(p1.data().wins||0),
losses:a1===0&&s1!==s2?(p1.data().losses||0)+1:(p1.data().losses||0),
draws:s1===s2?(p1.data().draws||0)+1:(p1.data().draws||0)
});

await p2.ref.update({
rating:Math.round(r2+K*(a2-e2)),
wins:a2===1?(p2.data().wins||0)+1:(p2.data().wins||0),
losses:a2===0&&s1!==s2?(p2.data().losses||0)+1:(p2.data().losses||0),
draws:s1===s2?(p2.data().draws||0)+1:(p2.data().draws||0)
});

await matchRef.update({
status:"approved",
approvedAt:firebase.firestore.FieldValue.serverTimestamp()
});

loadMatches();
}
</script>
</body>
</html>
