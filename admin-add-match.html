<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Match Result</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#050b1e;
  color:#fff;
}
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}
h1{text-align:center;margin-bottom:20px}
.card{
  background:#0b1622;
  padding:18px;
  border-radius:16px;
}
label{
  font-size:13px;
  opacity:.7;
}
select,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  font-size:15px;
}
button{
  background:#4f8cff;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
.msg{
  margin-top:12px;
  font-size:14px;
}
.success{color:#4cff8f}
.error{color:#ff6b6b}
</style>
</head>

<body>

<div class="container">
<h1>‚öîÔ∏è Add Match</h1>

<div class="card">

<label>Player 1</label>
<select id="player1"></select>

<label>Player 2</label>
<select id="player2"></select>

<label>Winner</label>
<select id="winner"></select>

<button onclick="addMatch()">Submit Match</button>

<div class="msg" id="msg"></div>
</div>
</div>

<script>
/* üî• FIREBASE INIT */
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(user=>{
  if(!user) location.href="admin-login.html";
});

/* LOAD PLAYERS */
let playersMap = {};

db.collection("players").get().then(snap=>{
  snap.forEach(doc=>{
    playersMap[doc.id] = doc.data();
    player1.innerHTML += `<option value="${doc.id}">${doc.data().username}</option>`;
    player2.innerHTML += `<option value="${doc.id}">${doc.data().username}</option>`;
    winner.innerHTML += `<option value="${doc.id}">${doc.data().username}</option>`;
  });
});

/* ADD MATCH */
function addMatch(){
  if(player1.value === player2.value){
    msg.innerHTML='<div class="error">Same player selected</div>';
    return;
  }

  const p1 = player1.value;
  const p2 = player2.value;
  const win = winner.value;

  const lose = win === p1 ? p2 : p1;

  const batch = db.batch();

  // save match
  const matchRef = db.collection("matches").doc();
  batch.set(matchRef,{
    player1:p1,
    player2:p2,
    winner:win,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  // winner update
  batch.update(db.collection("players").doc(win),{
    wins: firebase.firestore.FieldValue.increment(1),
    rating: firebase.firestore.FieldValue.increment(10)
  });

  // loser update
  batch.update(db.collection("players").doc(lose),{
    losses: firebase.firestore.FieldValue.increment(1),
    rating: firebase.firestore.FieldValue.increment(-5)
  });

  batch.commit().then(()=>{
    msg.innerHTML='<div class="success">‚úÖ Match added successfully</div>';
  }).catch(()=>{
    msg.innerHTML='<div class="error">‚ùå Error adding match</div>';
  });
}
</script>

</body>
</html>
