<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Match Result</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#050b1e;color:#fff}
.container{max-width:420px;margin:auto;padding:20px}
.card{background:#0b1622;padding:18px;border-radius:16px}
select,button{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:none}
button{background:#4f8cff;color:#fff;font-weight:bold}
button[disabled]{background:#333}
.msg{margin-top:12px}
</style>
</head>

<body>

<div class="container">
<h1>‚öîÔ∏è Add Match</h1>

<div class="card">
<select id="player1"></select>
<select id="player2"></select>
<select id="winner"></select>

<button id="submitBtn" onclick="addMatch()">Submit Match</button>
<div class="msg" id="msg"></div>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth=firebase.auth();
const db=firebase.firestore();
let CAN_ADD=false;

/* üîê AUTH + PERMISSION */
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }

  const admin=await db.collection("admins").doc(user.uid).get();
  if(!admin.exists || !admin.data().permissions?.addMatch){
    alert("Permission denied");
    submitBtn.disabled=true;
    return;
  }

  CAN_ADD=true;
});

/* LOAD PLAYERS */
db.collection("players").get().then(snap=>{
  snap.forEach(d=>{
    const o=`<option value="${d.id}">${d.data().username}</option>`;
    player1.innerHTML+=o;
    player2.innerHTML+=o;
    winner.innerHTML+=o;
  });
});

/* ADD MATCH */
async function addMatch(){
  if(!CAN_ADD){
    alert("Permission denied");
    return;
  }

  if(player1.value===player2.value){
    msg.innerHTML="‚ùå Same player";
    return;
  }

  const win=winner.value;
  const lose=win===player1.value?player2.value:player1.value;

  const batch=db.batch();
  const ref=db.collection("matches").doc();

  batch.set(ref,{
    player1:player1.value,
    player2:player2.value,
    winner:win,
    result:"win",
    time:firebase.firestore.FieldValue.serverTimestamp()
  });

  batch.update(db.collection("players").doc(win),{
    wins:firebase.firestore.FieldValue.increment(1),
    rating:firebase.firestore.FieldValue.increment(10)
  });

  batch.update(db.collection("players").doc(lose),{
    losses:firebase.firestore.FieldValue.increment(1),
    rating:firebase.firestore.FieldValue.increment(-5)
  });

  await batch.commit();
  msg.innerHTML="‚úÖ Match added";
}
</script>

</body>
</html>
