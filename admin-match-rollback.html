<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Match Rollback</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#050b1e;
  color:#fff;
  font-family:Segoe UI,sans-serif;
}
.container{
  max-width:800px;
  margin:auto;
  padding:20px;
}
.card{
  background:#0b1622;
  border-radius:14px;
  padding:14px;
  margin-top:12px;
  box-shadow:0 0 10px rgba(0,0,0,.4);
}
.win{border-left:5px solid #4cff8f}
.loss{border-left:5px solid #ff6b6b}
.small{font-size:12px;color:#aaa}
.btn{
  background:#ff4f4f;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  color:#fff;
  cursor:pointer;
  margin-top:10px;
}
h2{text-align:center;color:#4f8cff}
</style>
</head>

<body>
<div class="container">
<h2>üõë Match Rollback Panel</h2>
<div id="list"></div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const db = firebase.firestore();

db.collection("matches")
  .orderBy("time","desc")
  .onSnapshot(snap=>{
    list.innerHTML="";
    snap.forEach(doc=>{
      const m = doc.data();
      list.innerHTML += `
        <div class="card ${m.result}">
          <b>${m.result.toUpperCase()}</b> vs ${m.opponent}<br>
          Score: ${m.score}<br>
          <div class="small">Player UID: ${m.playerId}</div>
          <div class="small">Season: ${m.season || "N/A"}</div>
          <div class="small">${m.time?.toDate().toLocaleString()}</div>

          <button class="btn" onclick="rollback('${doc.id}')">
            ‚ùå Rollback Match
          </button>
        </div>
      `;
    });
  });

async function rollback(matchId){
  if(!confirm("Are you sure? This will revert player stats.")) return;

  const matchRef = db.collection("matches").doc(matchId);

  await db.runTransaction(async(t)=>{
    const matchSnap = await t.get(matchRef);
    if(!matchSnap.exists) throw "Match not found";

    const m = matchSnap.data();
    const playerRef = db.collection("players").doc(m.playerId);
    const playerSnap = await t.get(playerRef);

    if(!playerSnap.exists) throw "Player not found";

    // restore previous stats
    t.update(playerRef,{
      rating: m.ratingBefore,
      wins: m.winsBefore,
      losses: m.lossesBefore,
      rank: m.rankBefore
    });

    // delete match
    t.delete(matchRef);
  });

  alert("‚úÖ Match rolled back successfully");
}
</script>
</body>
</html>
