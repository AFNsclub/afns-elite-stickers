<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Season Reset | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#050b1e;
  color:#fff;
  font-family:Segoe UI, sans-serif;
}
.box{
  max-width:420px;
  margin:50px auto;
  padding:24px;
  background:#0b1622;
  border-radius:18px;
  box-shadow:0 0 20px rgba(0,0,0,.4);
}
h2{text-align:center;color:#4f8cff}
button{
  width:100%;
  padding:14px;
  margin-top:16px;
  border-radius:12px;
  border:none;
  background:#ff6b6b;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
  transition:.3s;
}
button:hover{background:#ff4b4b;}
.info{
  font-size:13px;
  color:#aaa;
  margin-top:10px;
  line-height:1.6;
}
#msg{margin-top:14px;font-size:14px}
.success{color:#4cff8f}
.error{color:#ff6b6b}
</style>
</head>

<body>

<div class="box">
  <h2>‚ôªÔ∏è Season Reset</h2>

  <div class="info">
    ‚Ä¢ Rating reset to <b>50</b><br>
    ‚Ä¢ Wins / Losses reset<br>
    ‚Ä¢ Match history remains SAFE<br>
    ‚Ä¢ Auto season (3x per year)<br>
    ‚Ä¢ üèÜ Auto Hall of Fame entry
  </div>

  <button onclick="resetSeason()">RESET SEASON</button>
  <div id="msg"></div>
</div>

<script>
/* üî• FIREBASE INIT */
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const auth = firebase.auth();
const db   = firebase.firestore();
const msg  = document.getElementById("msg");

/* üîê ADMIN AUTH CHECK */
auth.onAuthStateChanged(user=>{
  if(!user) location.href="admin-login.html";
});

/* ‚ôªÔ∏è RESET SEASON */
async function resetSeason(){
  if(!confirm("‚ö†Ô∏è Are you sure?\nThis will reset ALL players for a new season.")) return;

  msg.innerHTML="‚è≥ Processing season reset...";

  try{
    /* CURRENT ACTIVE SEASON */
    const activeSnap = await db.collection("seasons")
      .where("active","==",true).limit(1).get();

    const oldSeasonId = activeSnap.empty ? null : activeSnap.docs[0].id;

    /* üî• HALL OF FAME ENTRY */
    if(oldSeasonId){
      const topSnap = await db.collection("players")
        .where("seasonId","==",oldSeasonId)
        .orderBy("rating","desc")
        .limit(3)
        .get();

      let champions=[];
      topSnap.forEach(doc=>{
        const p = doc.data();
        champions.push({
          uid: doc.id,
          name: p.username || "Player",
          rating: p.rating || 0
        });
      });

      if(champions.length){
        await db.collection("hall_of_fame")
          .doc(oldSeasonId)
          .set({
            season: oldSeasonId,
            champions: champions,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
      }
    }

    /* üóì CREATE NEW SEASON */
    const seasonId = await getAutoSeason();

    /* üîÑ RESET ALL PLAYERS */
    const playersSnap = await db.collection("players").get();
    const batch = db.batch();

    playersSnap.forEach(doc=>{
      batch.update(doc.ref,{
        rating:50,
        wins:0,
        losses:0,
        draws:0,
        rank:"Bronze üü§",
        seasonId:seasonId
      });
    });

    await batch.commit();

    /* üìä SEASON SNAPSHOT */
    await db.collection("season_snapshots").doc(seasonId).set({
      seasonId: seasonId,
      totalPlayers: playersSnap.size,
      totalMatches: 0,
      avgRating: 50,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    /* üßæ ACTIVITY LOG */
    await db.collection("activity").add({
      type:"SEASON_RESET",
      seasonId:seasonId,
      text:`Season reset executed (${seasonId})`,
      time:firebase.firestore.FieldValue.serverTimestamp()
    });

    msg.innerHTML=`<div class="success">‚úÖ Season reset completed<br>üèÜ Hall of Fame updated</div>`;

  }catch(e){
    msg.innerHTML=`<div class="error">‚ùå ${e}</div>`;
    console.error(e);
  }
}

/* üóì AUTO SEASON (3x PER YEAR) */
async function getAutoSeason(){
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  let seasonId="";
  if(month<=4) seasonId=`${year}-S1`;
  else if(month<=8) seasonId=`${year}-S2`;
  else seasonId=`${year}-S3`;

  const seasonRef = db.collection("seasons").doc(seasonId);
  const snap = await seasonRef.get();

  if(!snap.exists){
    const activeSnap = await db.collection("seasons").where("active","==",true).get();
    const batch = db.batch();
    activeSnap.forEach(d=>batch.update(d.ref,{active:false}));
    await batch.commit();

    await seasonRef.set({
      name:seasonId,
      year:year,
      active:true,
      created:firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  return seasonId;
}
</script>

</body>
</html>
