<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AFNS Elite Strikers Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#0a0f21;color:#fff;text-align:center;}
.card{background:#0d1835;padding:20px;margin:20px;border-radius:12px;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);}
th{color:#ff44aa;}
.rank1{background:#FFD700;color:#000;}
.rank2{background:#C0C0C0;color:#000;}
.rank3{background:#CD7F32;color:#000;}
.rank-up{color:#4cff8f;font-weight:bold;}
.rank-down{color:#ff6b6b;font-weight:bold;}
button{padding:6px 12px;margin:5px;border:none;border-radius:6px;cursor:pointer;background:#00f7ff;color:#000;}
</style>
</head>
<body>

<h1>üèÜ AFNS Elite Strikers Dashboard</h1>

<div class="card">
<h2>Select Season</h2>
<select id="seasonSelect"></select>
<button onclick="toggleChart()">Toggle Chart</button>
</div>

<div class="card">
<h2>Seasonal Ranking</h2>
<table>
<thead>
<tr>
<th>Rank</th>
<th>Player</th>
<th>Wins</th>
<th>Losses</th>
<th>Draws</th>
<th>Rating</th>
<th>Œî</th>
</tr>
</thead>
<tbody id="seasonRanking"></tbody>
</table>
</div>

<div class="card">
<h2>All-time Ranking</h2>
<table>
<thead>
<tr>
<th>Rank</th>
<th>Player</th>
<th>Rating</th>
</tr>
</thead>
<tbody id="allRanking"></tbody>
</table>
</div>

<div class="card">
<h2>Historical Rating Chart</h2>
<canvas id="chart"></canvas>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain:"afnsclub.firebaseapp.com",
  projectId:"afnsclub"
});

const db = firebase.firestore();
const seasonSelect = document.getElementById("seasonSelect");
let chartType="bar";
let chartInstance;

// üî• Load Seasons (RULES COMPATIBLE ‚Üí season)
async function loadSeasons(){
  const snap = await db.collection("season").get();
  snap.forEach(doc=>{
    const opt=document.createElement("option");
    opt.value=doc.id;
    opt.textContent=doc.id;
    seasonSelect.appendChild(opt);
  });

  if(snap.docs.length){
    loadSeasonRanking(snap.docs[0].id);
  }
}

seasonSelect.addEventListener("change",()=>{
  loadSeasonRanking(seasonSelect.value);
});

// üî• Seasonal Ranking
async function loadSeasonRanking(seasonId){

  const snap = await db.collection("players")
  .where("seasonId","==",seasonId)
  .orderBy("rating","desc")
  .get();

  const tbody=document.getElementById("seasonRanking");
  tbody.innerHTML="";

  let rank=1;
  snap.forEach(doc=>{
    const p=doc.data();
    const prev=p.prevRank||rank;
    const delta=prev-rank;

    let cls="";
    if(rank==1) cls="rank1";
    if(rank==2) cls="rank2";
    if(rank==3) cls="rank3";

    tbody.innerHTML+=`
    <tr class="${cls}">
      <td>${rank}</td>
      <td>${p.username||"-"}</td>
      <td>${p.wins||0}</td>
      <td>${p.losses||0}</td>
      <td>${p.draws||0}</td>
      <td>${p.rating||0}</td>
      <td class="${delta>0?'rank-up':delta<0?'rank-down':''}">
      ${delta>0?'‚ñ≤'+delta:delta<0?'‚ñº'+(-delta):'-'}
      </td>
    </tr>
    `;
    rank++;
  });

  loadAllRanking();
  loadChart();
}

// üî• All Time Ranking
async function loadAllRanking(){
  const snap=await db.collection("players")
  .orderBy("rating","desc")
  .get();

  const tbody=document.getElementById("allRanking");
  tbody.innerHTML="";
  let rank=1;
  snap.forEach(doc=>{
    const p=doc.data();
    tbody.innerHTML+=`
    <tr>
      <td>${rank}</td>
      <td>${p.username}</td>
      <td>${p.rating}</td>
    </tr>`;
    rank++;
  });
}

// üî• Historical Chart
async function loadChart(){

  const seasonSnap=await db.collection("season").get();
  const seasons=seasonSnap.docs.map(d=>d.id);

  const playersSnap=await db.collection("players").get();
  const dataMap={};

  playersSnap.forEach(doc=>{
    const p=doc.data();
    if(!dataMap[p.username]) dataMap[p.username]={};
    dataMap[p.username][p.seasonId]=p.rating;
  });

  const datasets=[];
  let i=0;
  Object.keys(dataMap).forEach(name=>{
    const data=seasons.map(s=>dataMap[name][s]||0);
    datasets.push({
      label:name,
      data:data,
      borderColor:`hsl(${i*40},70%,60%)`,
      backgroundColor:`hsla(${i*40},70%,60%,0.5)`
    });
    i++;
  });

  if(chartInstance) chartInstance.destroy();

  chartInstance=new Chart(document.getElementById("chart"),{
    type:chartType,
    data:{labels:seasons,datasets:datasets},
    options:{responsive:true}
  });
}

function toggleChart(){
  chartType=chartType==="bar"?"line":"bar";
  loadChart();
}

loadSeasons();
</script>

</body>
</html>
