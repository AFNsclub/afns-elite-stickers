<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AFNS Player Stats</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#050b1e;
  color:#fff;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:16px;
}
h1{
  text-align:center;
  margin-bottom:14px;
}
.top-bar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:14px;
}
input,select{
  padding:10px;
  border-radius:10px;
  border:none;
  outline:none;
}
table{
  width:100%;
  border-collapse:collapse;
  background:rgba(255,255,255,.05);
  border-radius:14px;
  overflow:hidden;
}
th,td{
  padding:12px;
  text-align:center;
}
th{
  background:rgba(255,255,255,.08);
}
tr:hover{
  background:rgba(255,255,255,.07);
}
.rank{
  font-weight:bold;
}
.player-link{
  color:#4f8cff;
  text-decoration:none;
}
.player-link:hover{
  text-decoration:underline;
}
.loading{
  text-align:center;
  padding:20px;
  opacity:.7;
}
footer{
  margin-top:20px;
  text-align:center;
  font-size:12px;
  opacity:.5;
}
</style>
</head>

<body>

<div class="container">
  <h1>üèÜ AFNS Player Leaderboard</h1>

  <div class="top-bar">
    <input id="search" placeholder="Search player username...">
    <select id="seasonFilter">
      <option value="">All Seasons</option>
    </select>
  </div>

  <div id="loading" class="loading">Loading player stats...</div>

  <table id="table" style="display:none">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Player</th>
        <th>Team</th>
        <th>Wins</th>
        <th>Loss</th>
        <th>Win %</th>
        <th>Rating</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <footer>
    AFNs Elite Striker ‚Ä¢ Public Stats View
  </footer>
</div>

<script>
/* üî• FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyBtDxu0LJyb10ZkhH8IpxT5s8PcKc4nUxM",
  authDomain: "afnsclub.firebaseapp.com",
  projectId: "afnsclub"
});

const db = firebase.firestore();

const tbody = document.getElementById("tbody");
const search = document.getElementById("search");
const seasonFilter = document.getElementById("seasonFilter");
const table = document.getElementById("table");
const loading = document.getElementById("loading");

let players = [];
let seasons = new Set();

/* üîÑ LOAD PLAYERS */
db.collection("players").onSnapshot(snap=>{
  players=[];
  seasons.clear();

  snap.forEach(doc=>{
    const d = doc.data();
    players.push({
      uid: doc.id,
      username: d.username || doc.id,
      team: d.team || "-",
      wins: d.totalWins || 0,
      loss: d.totalLoss || 0,
      rating: d.rating || 0,
      seasons: d.seasons || {}
    });

    if(d.seasons){
      Object.keys(d.seasons).forEach(s=>seasons.add(s));
    }
  });

  fillSeasonFilter();
  render();
  loading.style.display="none";
  table.style.display="";
});

/* üè∑ SEASON FILTER */
function fillSeasonFilter(){
  seasonFilter.innerHTML='<option value="">All Seasons</option>';
  [...seasons].sort().forEach(s=>{
    const o=document.createElement("option");
    o.value=s;
    o.textContent=s;
    seasonFilter.appendChild(o);
  });
}

/* üîç SEARCH + FILTER */
search.oninput = render;
seasonFilter.onchange = render;

/* üß† RENDER TABLE */
function render(){
  tbody.innerHTML="";

  let arr=[...players];

  const q = search.value.toLowerCase();
  if(q){
    arr = arr.filter(p=>p.username.toLowerCase().includes(q));
  }

  const season = seasonFilter.value;
  if(season){
    arr = arr.map(p=>{
      const s = p.seasons[season];
      if(!s) return null;
      return {
        ...p,
        wins: s.wins || 0,
        loss: s.loss || 0,
        rating: s.rating || 0
      };
    }).filter(Boolean);
  }

  arr.sort((a,b)=>b.rating - a.rating);

  arr.forEach((p,i)=>{
    const total = p.wins + p.loss;
    const winp = total ? Math.round((p.wins/total)*100) : 0;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="rank">#${i+1}</td>
      <td>
        <a class="player-link" href="player.html?u=${p.uid}">
          ${p.username}
        </a>
      </td>
      <td>${p.team}</td>
      <td>${p.wins}</td>
      <td>${p.loss}</td>
      <td>${winp}%</td>
      <td>${p.rating}</td>
    `;
    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>
